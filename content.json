{"meta":{"title":"Rick's blog","subtitle":"åˆ†äº«ä¸€äº›é»‘ç§‘æŠ€","description":"","author":"Rick","url":"https://guaik.github.io","root":"/"},"pages":[{"title":"","date":"2020-04-12T15:26:27.457Z","updated":"2020-04-12T11:12:33.055Z","comments":false,"path":"tags/index.html","permalink":"https://guaik.github.io/tags/index.html","excerpt":"","text":""},{"title":"","date":"2020-04-12T15:26:27.457Z","updated":"2020-04-12T11:13:05.148Z","comments":false,"path":"categories/index.html","permalink":"https://guaik.github.io/categories/index.html","excerpt":"","text":""}],"posts":[{"title":"æœ´ç´ è´å¶æ–¯ç®—æ³•è¯†åˆ«åƒåœ¾çŸ­ä¿¡","slug":"æœ´ç´ è´å¶æ–¯ç®—æ³•è¯†åˆ«åƒåœ¾çŸ­ä¿¡","date":"2021-01-29T10:07:43.000Z","updated":"2021-01-29T10:27:54.347Z","comments":true,"path":"2021/01/29/æœ´ç´ è´å¶æ–¯ç®—æ³•è¯†åˆ«åƒåœ¾çŸ­ä¿¡/","link":"","permalink":"https://guaik.github.io/2021/01/29/%E6%9C%B4%E7%B4%A0%E8%B4%9D%E5%8F%B6%E6%96%AF%E7%AE%97%E6%B3%95%E8%AF%86%E5%88%AB%E5%9E%83%E5%9C%BE%E7%9F%AD%E4%BF%A1/","excerpt":"","text":"è®­ç»ƒé›†ä¸‹è½½(sms_data.txt)ç‚¹å‡»ä¸‹è½½ Cargo.toml1234567891011121314151617[package]name &#x3D; &quot;bayes&quot;version &#x3D; &quot;0.1.0&quot;authors &#x3D; [&quot;Rick.Gu &lt;rick@guaik.org&gt;&quot;]edition &#x3D; &quot;2018&quot;# See more keys and their definitions at https:&#x2F;&#x2F;doc.rust-lang.org&#x2F;cargo&#x2F;reference&#x2F;manifest.html[dependencies]ndarray &#x3D; &quot;0.14.0&quot;jieba-rs &#x3D; &quot;0.6&quot;serde &#x3D; &#123; version &#x3D; &quot;1.0&quot;, features &#x3D; [&quot;derive&quot;] &#125;serde_json &#x3D; &quot;1.0&quot;# [lib]# name &#x3D; &quot;bayes&quot;# crate-type &#x3D; [&quot;staticlib&quot;] bayes.rs123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276//! æœ´ç´ è´å¶æ–¯ç®—æ³•use jieba_rs::Jieba;use ndarray::&#123;self, arr1, Array1, Array2&#125;;use std::collections::HashSet;use std::fs;use std::io::Write;use serde::&#123;Deserialize, Serialize&#125;;use serde_json;use crate::utils;#[derive(Deserialize, Serialize)]pub struct BayesModel &#123; init_val: f64, // æ‰€æœ‰è¯çš„åˆå§‹åŒ–å‡ºç°æ•° denom: f64, // é»˜è®¤åˆ†æ¯ p0: Vec&lt;f64&gt;, // æ­£ç¡®æ¦‚ç‡æ•°ç»„ p1: Vec&lt;f64&gt;, // é”™è¯¯æ¦‚ç‡æ•°ç»„ p0_denom: f64, p1_denom: f64, pabusive: f64, // é”™è¯¯ç‡ vocabs: Vec&lt;String&gt;,&#125;pub struct Bayes &#123; init_val: f64, // æ‰€æœ‰è¯çš„åˆå§‹åŒ–å‡ºç°æ•° denom: f64, // é»˜è®¤åˆ†æ¯ p0: Array1&lt;f64&gt;, // æ­£ç¡®æ¦‚ç‡æ•°ç»„ p1: Array1&lt;f64&gt;, // é”™è¯¯æ¦‚ç‡æ•°ç»„ p0_denom: f64, p1_denom: f64, pabusive: f64, // é”™è¯¯ç‡ vocabs: HashSet&lt;String&gt;, jieba: Jieba,&#125;impl Bayes &#123; /// åˆ›å»ºæœ´ç´ è´å¶æ–¯å®ä¾‹ /// # å‚æ•° /// ## init_val: f64 /// å‘é‡çš„é»˜è®¤å€¼ï¼Œå¦‚æœå°äº0.0ï¼Œå°†è¢«è®¾ç½®ä¸º1.0 /// ## denom: f64 /// é»˜è®¤åˆ†æ¯ï¼Œå¦‚æœå°äºç­‰äº0.0ï¼Œå°†è¢«è®¾ç½®ä¸º2.0 /// /// # è¿”å›å€¼ï¼šBayes /// è¿”å›ç´ æœ´è´å¶æ–¯å®ä¾‹ pub fn new(init_val: f64, denom: f64) -&gt; Bayes &#123; let mut init_val = init_val; let mut denom = denom; if init_val &lt; 0.0 &#123; init_val = 1.0; &#125; if denom &lt;= 0.0 &#123; denom = 2.0; &#125; Bayes &#123; init_val, denom, p0: arr1(&amp;[]), p1: arr1(&amp;[]), p0_denom: 0.0, p1_denom: 0.0, pabusive: 0.0, vocabs: HashSet::new(), jieba: Jieba::new(), &#125; &#125; /// è®­ç»ƒæ¨¡å‹ /// # å‚æ•° /// ## data_set: &amp;str /// è¯¥å‚æ•°ä¸ºæ–‡ä»¶è·¯å¾„ï¼Œå¸¦è®­ç»ƒçš„æ•°æ®é›†ï¼Œè¯¥æ•°æ®é›†éœ€è¦è¿›è¡Œé¢„å¤„ç†å°†å…¶ä¸­çš„ç©ºæ ¼å…¨éƒ¨å»é™¤ï¼Œç„¶åä½¿ç”¨ç©ºæ ¼å°†æ ‡ç­¾ä¸å†…å®¹è¿›è¡Œåˆ†éš”,å¦‚ä¸‹æ‰€ç¤ºï¼š /// /// &gt; 0 è¿™æ˜¯ä¸€æ¡æ­£å¸¸çŸ­ä¿¡ /// &gt; 1 è¿™æ˜¯ä¸€æ¡åƒåœ¾çŸ­ä¿¡ /// /// # è¿”å›å€¼ï¼šResult /// æˆåŠŸæ—¶è¿”å›ç©ºå…ƒç»„ï¼Œå¤±è´¥æ—¶è¿”å›é”™è¯¯æç¤ºä¿¡æ¯ pub fn train(&amp;mut self, data_set: &amp;str) -&gt; Result&lt;(), &amp;'static str&gt; &#123; let mut classifys: Vec&lt;f64&gt; = Vec::new(); // åˆ†ç±» let mut texts: Vec&lt;Vec&lt;String&gt;&gt; = Vec::new(); // åŠ è½½æ•°æ® if let Ok(lines) = utils::read_lines(data_set) &#123; for line in lines &#123; if let Ok(v) = line &#123; let vs: Vec&lt;&amp;str&gt; = v.split(' ').collect(); // è·å–åˆ†ç±» if let Some(c) = vs.get(0) &#123; if let Ok(c1) = c.parse() &#123; classifys.push(c1); &#125; else &#123; return Err(\"classify format failed\"); &#125; &#125; else &#123; return Err(\"get classify failed\"); &#125; // è·å–å†…å®¹ if let Some(t) = vs.get(1) &#123; let t1: Vec&lt;String&gt; = self .jieba .cut(t, false) .into_iter() .map(String::from) .collect(); texts.push(t1); &#125; else &#123; return Err(\"get text failed\"); &#125; &#125; &#125; &#125; else &#123; return Err(\"read data_set failed\"); &#125; // -- åŠ è½½æ•°æ® // è·å–å”¯ä¸€è¯æ±‡ for doc in &amp;texts &#123; // let doc: HashSet&lt;&amp;String&gt; = doc.iter().collect(); self.vocabs = self .vocabs .union(&amp;doc.iter().map(String::from).collect()) .into_iter() .map(|x| x.to_string()) .collect(); &#125; // println!(\"&#123;:?&#125;\", self.vocabs); // å°†æ–‡æœ¬æ•°æ®è½¬ä¸ºå¯¹åº”å­˜åœ¨çš„æ•°å­—å‘é‡ // æ ¹æ®æ•°æ®å†…å®¹åˆå§‹åŒ–2Dæ•°ç»„ let mut vocab_of_arr = Array2::from_elem((texts.len(), self.vocabs.len()), 0.0); for (line, doc) in (&amp;texts).iter().enumerate() &#123; for w in doc &#123; if let Some(col) = self.vocabs.iter().position(|x| x == w) &#123; vocab_of_arr.row_mut(line)[col] = 1.0; &#125; &#125; &#125; // println!(\"&#123;:?&#125;\", vocab_of_arr); // å°†åˆ†ç±»æ•°æ®å­˜å‚¨array let classifys = match Array1::from_shape_vec((&amp;classifys).len(), classifys) &#123; Ok(vec) =&gt; vec, Err(_) =&gt; return Err(\"gen classifys array failed\"), &#125;; // println!(\"&#123;:?&#125;\", classifys); // è®¡ç®—é”™è¯¯å æ¯” self.pabusive = classifys.sum() as f64 / classifys.len() as f64; self.p0 = Array1::from_elem(self.vocabs.len(), self.init_val); self.p1 = Array1::from_elem(self.vocabs.len(), self.init_val); self.p0_denom = self.denom; self.p1_denom = self.denom; for (i, classify) in classifys.iter().enumerate() &#123; if *classify == 1.0 &#123; self.p1 += &amp;vocab_of_arr.row(i); self.p1_denom += &amp;vocab_of_arr.row(i).sum(); &#125; else &#123; self.p0 += &amp;vocab_of_arr.row(i); self.p0_denom += &amp;vocab_of_arr.row(i).sum(); &#125; &#125; let calc = |z: &amp;Array1&lt;f64&gt;, d: f64| -&gt; Array1&lt;f64&gt; &#123; z.iter().map(|x| (x / d).log(std::f64::consts::E)).collect() &#125;; self.p0 = calc(&amp;self.p0, self.p0_denom); self.p1 = calc(&amp;self.p1, self.p1_denom); Ok(()) &#125; /// åˆ†ç±»å™¨ /// # å‚æ•° /// ## text: &amp;str /// å¾…åˆ†ç±»çš„æ–‡æœ¬å­—ç¬¦ä¸² /// /// # è¿”å›å€¼ï¼šResult /// å¦‚æœåˆ†ç±»æˆåŠŸï¼Œåˆ™è¿”å›Okå˜ä½“ã€‚å¦‚æœåˆ†ç±»å¤±è´¥ï¼Œåˆ™è¿”å›Errå˜ä½“ã€‚ /// Okå˜ä½“ä¸­å¦‚æœp1 &gt; p0åˆ™ä¸ºtrueï¼Œå¦åˆ™ä¸ºfalseã€‚ pub fn classify(&amp;self, text: &amp;str) -&gt; Result&lt;bool, &amp;'static str&gt; &#123; if text == \"\" &#123; return Err(\"text ie empty\"); &#125; let text_vec = self.jieba.cut(text, false); let mut train_vec = Array1::from_elem(self.vocabs.len(), 0.0); for w in &amp;text_vec &#123; if let Some(col) = self.vocabs.iter().position(|x| x == *w) &#123; train_vec[col] = 1.0; &#125; &#125; let p0: f64 = (&amp;train_vec * &amp;self.p0).sum() + (1.0 - self.pabusive.log(std::f64::consts::E)); let p1: f64 = (&amp;train_vec * &amp;self.p1).sum() + (self.pabusive.log(std::f64::consts::E)); Ok(p1 &gt; p0) &#125; /// ä¿å­˜è®­ç»ƒæ¨¡å‹ pub fn save_model(&amp;self, model_name: &amp;str) -&gt; Result&lt;(), &amp;'static str&gt; &#123; // è½¬æ¢æ•°æ®ç±»å‹ let vocabs: Vec&lt;String&gt; = self.vocabs.iter().map(|x| x.to_string()).collect(); let p0: Vec&lt;f64&gt; = self.p0.to_vec(); let p1: Vec&lt;f64&gt; = self.p1.to_vec(); // jsonå¯¹è±¡ let model = BayesModel &#123; init_val: self.init_val, denom: self.denom, p0, p1, p0_denom: self.p0_denom, p1_denom: self.p1_denom, pabusive: self.pabusive, vocabs, &#125;; let json_str = match serde_json::to_string(&amp;model) &#123; Ok(v) =&gt; v, Err(_) =&gt; return Err(\"model to json string failed\"), &#125;; let mut file = match fs::File::create(model_name) &#123; Ok(f) =&gt; f, Err(_) =&gt; return Err(\"create model file failed\"), &#125;; file.write_all(json_str.as_bytes()) .map_err(|_| \"write model failed\")?; Ok(()) &#125; /// åŠ è½½æ¨¡å‹ pub fn load_model(&amp;mut self, model_path: &amp;str) -&gt; Result&lt;(), &amp;'static str&gt; &#123; let model_str = match fs::read_to_string(model_path) &#123; Ok(v) =&gt; v, Err(_) =&gt; return Err(\"read model failed\"), &#125;; let model: BayesModel = match serde_json::from_str(&amp;model_str) &#123; Ok(v) =&gt; v, Err(_) =&gt; return Err(\"json to model failed\"), &#125;; self.p0 = match Array1::from_shape_vec(model.p0.len(), model.p0) &#123; Ok(v) =&gt; v, Err(_) =&gt; return Err(\"set p0 failed\"), &#125;; self.p1 = match Array1::from_shape_vec(model.p1.len(), model.p1) &#123; Ok(v) =&gt; v, Err(_) =&gt; return Err(\"set p1 failed\"), &#125;; self.vocabs = model.vocabs.iter().map(|x| x.to_string()).collect(); self.pabusive = model.pabusive; Ok(()) &#125;&#125;#[cfg(test)]mod tests &#123; use super::*; #[test] fn test_train_and_save() &#123; let mut b = Bayes::new(1.0, 2.0); b.train(\"sms_data.txt\").unwrap(); b.save_model(\"bayes_model.json\").unwrap(); &#125; #[test] fn test_load_and_classify() &#123; let mut b = Bayes::new(1.0, 2.0); b.load_model(\"bayes_model.json\").unwrap(); println!(\"star\"); println!(\"&#123;&#125;\", b.classify(\"éªŒè¯ç 417520ï¼Œç”¨äºæ³¨å†Œ/ç™»å½•ï¼Œ10åˆ†é’Ÿå†…æœ‰æ•ˆã€‚éªŒè¯ç æä¾›ç»™ä»–äººå¯èƒ½å¯¼è‡´è´¦å·è¢«ç›—ï¼Œè¯·å‹¿æ³„æ¼ï¼Œè°¨é˜²è¢«éª—ã€‚ \").unwrap()); println!(\"end\"); &#125;&#125;","categories":[],"tags":[{"name":"rust","slug":"rust","permalink":"https://guaik.github.io/tags/rust/"},{"name":"æœºå™¨å­¦ä¹ ","slug":"æœºå™¨å­¦ä¹ ","permalink":"https://guaik.github.io/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"},{"name":"æœ´ç´ è´å¶æ–¯","slug":"æœ´ç´ è´å¶æ–¯","permalink":"https://guaik.github.io/tags/%E6%9C%B4%E7%B4%A0%E8%B4%9D%E5%8F%B6%E6%96%AF/"}]},{"title":"CentOS7éƒ¨ç½²MongoDBå‰¯æœ¬é›†","slug":"CentOS7éƒ¨ç½²MongoDBå‰¯æœ¬é›†","date":"2020-08-09T06:39:39.000Z","updated":"2020-09-24T06:14:47.238Z","comments":true,"path":"2020/08/09/CentOS7éƒ¨ç½²MongoDBå‰¯æœ¬é›†/","link":"","permalink":"https://guaik.github.io/2020/08/09/CentOS7%E9%83%A8%E7%BD%B2MongoDB%E5%89%AF%E6%9C%AC%E9%9B%86/","excerpt":"","text":"å®‰è£…MongoDBåˆ›å»ºmongodbæºæ–‡ä»¶vi /etc/yum.repos.d/mongodb-org-4.4.repo è¾“å…¥ä»¥ä¸‹å†…å®¹123456[mongodb-org-4.4]name=MongoDB Repositorybaseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/4.4/x86_64/gpgcheck=1enabled=1gpgkey=https://www.mongodb.org/static/pgp/server-4.4.asc ä½¿ç”¨yumå®‰è£…sudo yum install -y mongodb-org é…ç½®å‰¯æœ¬é›†åˆ›å»ºä»¥ä¸‹ç›®å½• ç›®å½•å ç”¨é€” config å­˜å‚¨é…ç½®æ–‡ä»¶ data å­˜å‚¨æ•°æ®æ–‡ä»¶ keyfile å­˜å‚¨å¯†é’¥æ–‡ä»¶ log å­˜å‚¨æ—¥å¿—æ–‡ä»¶ run å­˜å‚¨pidæ–‡ä»¶ 123456mkdir ~/mongodbcd ~/mongodbmkdir config data keyfile log runcd datamkdir node1 node2 node3cd .. ç¼–è¾‘èŠ‚ç‚¹1é…ç½®æ–‡ä»¶vi ./config/node1.conf è¾“å…¥ä»¥ä¸‹å†…å®¹ 123456789101112131415161718192021222324252627282930net: port: 26001 bindIp: 0.0.0.0storage: engine: wiredTiger directoryPerDB: true dbPath: ~/mongodb/data/node1 journal: enabled: truesystemLog: destination: file logAppend: true path: ~/mongodb/log/node1.logoperationProfiling: slowOpThresholdMs: 10000replication: oplogSizeMB: 10240 replSetName: guaikprocessManagement: fork: true pidFilePath: ~/mongodb/run/node1.pidsecurity: authorization: \"enabled\" clusterAuthMode: keyFile keyFile: ~/mongodb/keyfile/mongo.key å­—æ®µå æè¿° port ç›‘å¬ç«¯å£å· replSetName æ˜¯èŠ‚ç‚¹åç§° å¤åˆ¶è¯¥é…ç½®æ–‡ä»¶ï¼Œåˆ›å»ºèŠ‚ç‚¹2å’ŒèŠ‚ç‚¹3çš„é…ç½®æ–‡ä»¶ 12cp ./config/node1.conf ./config/node2.confcp ./config/node1.conf ./config/node3.conf node2.confå’Œnode3.confåˆ†åˆ«ä½¿ç”¨ç«¯å£ï¼š26002å’Œ26003ï¼Œå¹¶ä¸”ä¿®æ”¹æ•°æ®ç›®å½•ï¼Œæ—¥å¿—ç›®å½•å’Œpidæ–‡ä»¶ï¼ˆå°†ç›¸å…³çš„node1æ”¹æˆnode2å’Œnode3å³å¯ï¼‰ã€‚ åˆ›å»ºå¯†é’¥æ–‡ä»¶12openssl rand -base64 756 &gt; ./keyfile/mongo.keychmod 600 ./keyfile/mongo.key å¯åŠ¨èŠ‚ç‚¹å’Œå…³é—­èŠ‚ç‚¹123456789# å¯åŠ¨èŠ‚ç‚¹mongod -f ~/mongodb/config/node1.conf --authmongod -f ~/mongodb/config/node2.conf --authmongod -f ~/mongodb/config/node3.conf --auth# å…³é—­èŠ‚ç‚¹mongod -f ï½/mongodb/config.node1.cinf --shutdownmongod -f ï½/mongodb/config.node2.cinf --shutdownmongod -f ï½/mongodb/config.node3.cinf --shutdown è¿æ¥èŠ‚ç‚¹å¹¶åˆå§‹åŒ–å‰¯æœ¬é›†mongo --port=26001 è¿æ¥æˆåŠŸåè¾“å…¥è¾“å…¥ä»¥ä¸‹æŒ‡ä»¤ï¼Œåˆ›å»ºå‰¯æœ¬é›†é…ç½®ã€‚ 12345678config = &#123; _id : \"guaik\", members : [ &#123;_id : 0, host : \"192.168.1.100:26001\" &#125;, &#123;_id : 1, host : \"192.168.1.101:26002\" &#125;, &#123;_id : 2, host : \"192.168.1.102:26003\"&#125; ]&#125;; åˆå§‹åŒ–å‰¯æœ¬é›† rs.initiate(config); æŸ¥çœ‹åˆ›å»ºçŠ¶æ€ rs.status() é…ç½®adminç”¨æˆ·123456use admin;db.createUser(&#123; user:\"admin\", pwd:\"admin\", roles:[&#123;role:\"root\",db:\"admin\"&#125;]&#125;); åˆ‡æ¢adminæ•°æ®åº“å¹¶ç™»é™†12use admin;db.auth(\"admin\", \"admin\"); å®¢æˆ·ç«¯è¿æ¥å‰¯æœ¬é›†å­—ç¬¦ä¸²1mongodb://admin:admin@&#123;host&#125;:26001,&#123;host&#125;:26002,&#123;host&#125;:26003 è¿æ¥å¤±è´¥çš„è¯·æ£€æŸ¥é˜²ç«å¢™æ˜¯å¦å¼€æ”¾ç«¯å£ã€‚","categories":[],"tags":[{"name":"mongodb","slug":"mongodb","permalink":"https://guaik.github.io/tags/mongodb/"}]},{"title":"æå®šç½‘ç»œçˆ¬è™«ç™»é™†éªŒè¯-ä½¿ç”¨æµè§ˆå™¨Cookie","slug":"æå®šç½‘ç»œçˆ¬è™«ç™»é™†éªŒè¯-ä½¿ç”¨æµè§ˆå™¨Cookie","date":"2020-06-04T02:04:40.000Z","updated":"2020-06-04T08:46:32.439Z","comments":true,"path":"2020/06/04/æå®šç½‘ç»œçˆ¬è™«ç™»é™†éªŒè¯-ä½¿ç”¨æµè§ˆå™¨Cookie/","link":"","permalink":"https://guaik.github.io/2020/06/04/%E6%90%9E%E5%AE%9A%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB%E7%99%BB%E9%99%86%E9%AA%8C%E8%AF%81-%E4%BD%BF%E7%94%A8%E6%B5%8F%E8%A7%88%E5%99%A8Cookie/","excerpt":"","text":"ç™»é™†éªŒè¯æ˜¯ä»€ä¹ˆï¼Ÿhttps://www.wjx.cn/wjx/viewfile.aspx?path=https%3a%2f%2fpubuserqiniu.paperol.cn%2f80373144_1_q1_1591205817ZF4mBh.png%3fattname%3d1_1_3EADD86A-FFEB-469C-A77E-A6F5C7B0D635.png&amp;activity=80373144 å…ˆç‚¹ä¸Šè¾¹é“¾æ¥ï¼Œå‘ç°æ‰“å¼€çš„ä¸æ˜¯ä¸€å¼ å›¾ç‰‡ï¼Œè€Œæ˜¯ä¸€ä¸ªç™»é™†é¡µé¢ã€‚ ç™»é™† åˆ†æurlåˆ†æä¸Šè¾¹urlæ˜¯ä¸€ä¸ªå›¾ç‰‡è¿æ¥ï¼Œä½†æ˜¯å®é™…çš„å›¾ç‰‡urlæ˜¯ä½œä¸ºå‚æ•°(path)ä¼ ç»™æœåŠ¡å™¨çš„ 1https%3a%2f%2fpubuserqiniu.paperol.cn%2f80373144_1_q1_1591205817ZF4mBh.png%3fattname%3d1_1_3EADD86A-FFEB-469C-A77E-A6F5C7B0D635.png ä½¿ç”¨urlè§£ç çœ‹ä¸‹å›¾ç‰‡åœ°å€ 1https://pubuserqiniu.paperol.cn/80373144_1_q1_1591205817ZF4mBh.png?attname=1_1_3EADD86A-FFEB-469C-A77E-A6F5C7B0D635.png å¯ä»¥çŸ¥é“å›¾ç‰‡å­˜å‚¨ç”¨çš„æ˜¯ä¸ƒç‰›äº‘çš„å¯¹è±¡å­˜å‚¨æœåŠ¡ã€‚ ç™»é™†åˆ†æ Chromeæµè§ˆå™¨ï¼Œæ‰“å¼€â€œå¼€å‘è€…å·¥å…·â€ï¼Œç‚¹å‡»â€œNetworkâ€ï¼Œå¦‚æœâ€œNetworkâ€ä¸­å­˜åœ¨å†…å®¹ï¼Œå°±å…ˆæ¸…ç©ºä¸€ä¸‹ã€‚ è¾“å…¥è´¦å·å¯†ç ï¼ˆå¯èƒ½éœ€è¦è¾“å…¥éªŒè¯ç ï¼‰ç™»é™†ï¼ŒæŸ¥çœ‹â€œNetworkâ€ä¸­çš„æ•°æ®ï¼š å½“è¾“å…¥å®Œè´¦å·å¯†ç åï¼Œå›¾ç‰‡å·²ç»è¢«ä¸‹è½½äº† åˆ†æ é€šè¿‡ä¸Šå›¾å¯ä»¥çŸ¥é“è·å–ä¸€ä¸ªå›¾ç‰‡æ˜¯ç»è¿‡äº†3ä¸ªæ­¥éª¤çš„ï¼Œå‰ä¸¤æ­¥éª¤çš„è¿”å›çŠ¶æ€ç éƒ½æ˜¯302ï¼ˆé‡å®šå‘ï¼‰ï¼Œç¬¬ä¸‰æ­¥æ‰æ˜¯çœŸæ­£çš„è¯·æ±‚ã€‚ ç‚¹å‡»ç¬¬ä¸€ä¸ªURL åˆ†æ1 å› ä¸ºæ˜¯302çŠ¶æ€ï¼Œæ‰€ä»¥æ£€æŸ¥è¿”å›æ•°æ®çš„å¤´éƒ¨ä¿¡æ¯ï¼Œèƒ½å¤Ÿå‘ç°ä¸¤ä¸ªå…³é”®å‚æ•°ï¼š1ã€é‡å®šå‘åœ°å€ï¼ˆLocationï¼‰ã€‚2ã€æœ¬åœ°è¯·æ±‚ä¼šåœ¨æœ¬åœ°è®¾ç½®çš„Cookieã€‚ æ‰€æœ‰æˆ‘ä»¬åœ¨å¼€å‘è„šæœ¬çš„æ—¶å€™ä¹Ÿä¼šä½¿ç”¨åˆ°Cookieçš„åŠŸèƒ½ã€‚ ç‚¹å‡»ç¬¬äºŒä¸ªURL(ä¸ºç¬¬ä¸€ä¸ªURLé‡å®šå‘çš„ç›®æ ‡åœ°å€) åˆ†æ2 è¿™é‡Œæœ‰ä¸ªé‡è¦ä¿¡æ¯ï¼Œé‡å®šå‘çš„åœ°å€ä¸­å¸¦æœ‰tokenå‚æ•° ç¬¬ä¸‰æ­¥ï¼Œæœ€åä¸€æ­¥ï¼ åˆ†æ3 ç»§ç»­åˆ†æè¿”å›æ•°æ®ï¼Œå‘ç°Content-Typeæ˜¯image/pngï¼Œè¿™æ—¶å€™å°±å¯ä»¥ç¡®è®¤è¿”å›çš„æ•°æ®æ˜¯å›¾ç‰‡æ ¼å¼äº†ã€‚ çˆ¬è™«è®¾è®¡å¼€å‘è¯­è¨€ï¼šPython3.X éœ€æ±‚1ï¼šéœ€è¦ç™»é™†éªŒè¯ï¼Œå¹¶ä¸”è¦å¤„ç†ç™»é™†éªŒè¯ç å®ç°ï¼šç›´æ¥ä½¿ç”¨æµè§ˆå™¨ç™»é™†åä½¿ç”¨æµè§ˆå™¨ç”Ÿæˆçš„Cookieï¼Œç”¨åˆ°çš„åº“ï¼š 1pip3 install browser_cookie3 éœ€æ±‚2ï¼šåœ¨è¯·æ±‚æ•°æ®çš„æ—¶å€™ï¼Œå‰ä¸¤æ¬¡é‡å®šå‘åº”ç­”çš„headersä¸­éƒ½éœ€è¦è®¾ç½®Cookieå®ç°ï¼šä½¿ç”¨urllib.request.HTTPCookieProcessoræ¥ç®¡ç†Cookie DEMOâš ï¸æ³¨æ„äº‹é¡¹ï¼š 1ã€æµ‹è¯•å‘ç°éœ€è¦ç™»é™†ç®¡ç†åå°ï¼Œä¸‹è½½æœ€æ–°çš„åˆ†ææŠ¥å‘Š(excel)ï¼Œä»é‡Œè¾¹æ‹¿åˆ°å›¾ç‰‡çš„urlæ‰èƒ½ä½¿ç”¨å½“å‰æµè§ˆå™¨çš„Cookieè¿›è¡Œæ“ä½œã€‚ 2ã€ç¬¬ä¸€æ¬¡GETè¯·æ±‚åå‘ç°headersä¸­æ²¡æœ‰Locationå­—æ®µï¼Œä½†æ˜¯åœ¨è¿”å›å†…å®¹ä¸­æ‰¾åˆ°äº†é‡å®šå‘ç”¨åˆ°çš„çš„urlï¼Œæ‰€ä»¥ç”¨xpathæå–å‡ºæ¥ä½¿ç”¨ã€‚ 3ã€browser_cookie3è·å–Chromeçš„Cookieå­˜åœ¨é—®é¢˜ï¼Œè·å–Firefoxçš„Cookieå¯æ­£å¸¸ä½¿ç”¨ã€‚ 123456789101112131415161718192021222324252627282930# -*- coding: utf-8 -*-import browser_cookie3import urllib.requestfrom lxml import etreedef download(): url = \"https://www.wjx.cn/wjx/viewfile.aspx?path=https%3a%2f%2fpubuserqiniu.paperol.cn%2f80373144_1_q1_1591205817ZF4mBh.png%3fattname%3d1_1_3EADD86A-FFEB-469C-A77E-A6F5C7B0D635.png&amp;activity=80373144\" filename = \"./demo.png\" try: # åŠ è½½ç«ç‹æµè§ˆå™¨Cookie cj = browser_cookie3.Firefox().load() opener = urllib.request.build_opener(urllib.request.HTTPCookieProcessor(cj)) request = urllib.request.Request(url) # ç¬¬ä¸€æ¬¡è¯·æ±‚ response = opener.open(request) data = response.read() html = etree.HTML(data) url = 'https://www.wjx.cn' + html.xpath('//a/@href')[0] request = urllib.request.Request(url, method=\"GET\") # ç¬¬äºŒæ¬¡è¯·æ±‚ response = opener.open(request) if (response.getcode() == 200): with open(filename, \"wb\") as f: f.write(response.read()) # å°†å†…å®¹å†™å…¥å›¾ç‰‡ except Exception as e: print(e)if __name__ == \"__main__\": download() å¤‡æ³¨è¯·åˆç†ä½¿ç”¨çˆ¬è™«ï¼Œéµå¾ªç½‘ç«™robot.txtè§„åˆ™","categories":[],"tags":[{"name":"çˆ¬è™«","slug":"çˆ¬è™«","permalink":"https://guaik.github.io/tags/%E7%88%AC%E8%99%AB/"},{"name":"éªŒè¯","slug":"éªŒè¯","permalink":"https://guaik.github.io/tags/%E9%AA%8C%E8%AF%81/"}]},{"title":"Flutterä½¿ç”¨SharedPreferencesï¼šå•ä¾‹+åŒæ­¥","slug":"Flutterä½¿ç”¨SharedPreferencesï¼šå•ä¾‹+åŒæ­¥","date":"2020-05-23T13:38:32.000Z","updated":"2020-06-19T07:48:52.506Z","comments":true,"path":"2020/05/23/Flutterä½¿ç”¨SharedPreferencesï¼šå•ä¾‹+åŒæ­¥/","link":"","permalink":"https://guaik.github.io/2020/05/23/Flutter%E4%BD%BF%E7%94%A8SharedPreferences%EF%BC%9A%E5%8D%95%E4%BE%8B+%E5%90%8C%E6%AD%A5/","excerpt":"","text":"Flutterå¦‚ä½•æœ¬åœ°å­˜å‚¨K/Væ•°æ®å‘¢ï¼ŸSharedPreferencesæ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œå½“ç„¶å‡ ä¹æ‰€æœ‰åµŒå…¥å¼ç³»ç»Ÿéƒ½æ”¯æŒSQLiteï¼Œä½ ä¹æ„å°±å¥½ã€‚ å®‰è£…SharedPreferences åœ¨pubspec.yamlä¸­æ·»åŠ ä¾èµ–é¡¹ 12dependencies: shared_preferences: ^0.5.7+3 å®‰è£…ä¾èµ–é¡¹flutter pub get SharedPreferenceså¦‚ä½•ä½¿ç”¨ï¼Ÿå¤ªç®€å•äº†ï¼Œç›´æ¥ä¸Šä»£ç 123456789101112// å­˜å‚¨tokenå­—ç¬¦ä¸²void SetToken(token) async &#123; this.prefs = await SharedPreferences.getInstance(); this.prefs.setString(\"token\", token);&#125;// è·å–tokenå­—ç¬¦ä¸²Future&lt;String&gt; GetToken() async &#123; this.prefs = await SharedPreferences.getInstance(); String token = this.prefs.getString(\"token\"); return token == null ? \"\" : token;&#125; ä¸Šé¢ç¤ºä¾‹ç”¨äº†setStringå’ŒgetStringæ¥å¤„ç†å­—ç¬¦ä¸²ï¼Œè¿˜æ”¯æŒå¯¹int,bool,double,List&lt;String&gt;ç±»å‹çš„å¤„ç†ã€‚ ç¤ºä¾‹åˆ†æ await SharedPreferences.getInstance()ä»è¿™è¡Œä»£ç å¯ä»¥äº†è§£åˆ°çš„ä¿¡æ¯æ˜¯ï¼š1ã€SharedPreferencesé‡‡ç”¨äº†å¼‚æ­¥è°ƒç”¨ã€‚2ã€é™æ€æ–¹æ³•getInstance()å¯ä»¥ç¡®å®šå®ƒæ˜¯ä¸ªå•ä¾‹æ¨¡å¼ã€‚ å¦‚æœæ‰€æœ‰ä½¿ç”¨åˆ°å­˜å‚¨çš„å‡½æ•°éƒ½é‡‡ç”¨å¼‚æ­¥è°ƒç”¨å¯èƒ½ä¼šäº§ç”Ÿä¸€äº›é—®é¢˜ï¼Œåœ¨Flutterçš„é¡µé¢ä»£ç ä¸­Widget build(BuildContext context)éœ€è¦è¿”å›ä¸€ä¸ªWidgetçš„å¯¹è±¡ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦ä»æœ¬åœ°å­˜å‚¨ä¸­è¯»å–çŠ¶æ€å€¼æ¥ç¡®å®šè¿”å›ä»€ä¹ˆé¡µé¢ã€‚å¦‚æœæ˜¯å¼‚æ­¥è°ƒç”¨çš„è¯å¯èƒ½ä¼šè¿”å›ä¸€ä¸ªnullå€¼è€Œå¯¼è‡´ç¼–è¯‘æŠ¥é”™ï¼Œå› ä¸ºå¼‚æ­¥è°ƒç”¨ä¸ä¼šç­‰å¾…å‡½æ•°æ‰§è¡Œå®Œå°±ç»§ç»­æ‰§è¡Œä¸‹é¢çš„æµç¨‹äº†ï¼Œè¿™æ—¶å€™å¾ˆæœ‰å¯èƒ½å°±æ‰§è¡Œå®Œå‡½æ•°å¹¶ä¸”ä»€ä¹ˆéƒ½æ²¡è¿”å›ã€‚ 123456789101112131415161718class _StartupPageState extends State&lt;StartupPage&gt; &#123; @override Widget build(BuildContext context) &#123; Widget page; SharedPreferences.getInstance().then((prefs) &#123; var isFirst = prefs.getBool(\"isFirst\"); if (isFirst == null || false) &#123; // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡ç™»é™†ï¼Œåˆ™æ˜¾ç¤ºå¯åŠ¨é¡µ page = BootstrapPage(); &#125; else &#123; // å¦åˆ™æ‰§è¡Œè·³è½¬åˆ°ç™»é™†é¡µ page = LoginPage(); &#125; &#125;); // è¿™é‡Œå¯èƒ½è¿”å›nullå€¼ return page; &#125;&#125; SharedPreferencesä½¿ç”¨å•ä¾‹æ¨¡å¼å†å°è£… åœ¨mainå‡½æ•°ä¸­è°ƒç”¨Initç”Ÿæˆå®åŠ›å¹¶å­˜å‚¨SharedPreferenceså¯¹ï¼Œè¿™æ ·å°±ä¸ç”¨æ¯æ¬¡å¼‚æ­¥è·å–äº†ã€‚ 123456789101112131415class Storage &#123; Storage._(); SharedPreferences prefs; static Storage _instance; static Storage getInstance() &#123; if(_instance == null) &#123; _instance = Storage._(); &#125; return _instance; &#125; Init() async &#123; this.prefs = await SharedPreferences.getInstance(); &#125;&#125; åˆå§‹åŒ–123456789void startup() async &#123; await Storage.getInstance().Init(); runApp(new MyApp());&#125;void main() &#123; WidgetsFlutterBinding.ensureInitialized(); startup();&#125; ä½¿ç”¨Storageå•ä¾‹ æ„Ÿè°¢çŒ«å“¥æé†’ï¼šåœ¨SharedPreferencesä¸­ï¼Œæ‰€æœ‰çš„å†™å…¥æ“ä½œéƒ½æ˜¯å¼‚æ­¥å‡½æ•°ï¼ŒåŒ…å«ï¼ˆset, clearï¼‰ï¼Œæ‰€æœ‰çš„getéƒ½æ˜¯åŒæ­¥å‡½æ•°ã€‚ 1234567891011121314151617// å­˜å‚¨tokenå­—ç¬¦ä¸²// setStringä¸ºå¼‚æ­¥å‡½æ•°ï¼Œå¦‚æœæ˜¯åŒæ­¥é€»è¾‘éœ€è¦ä½¿ç”¨awaitã€‚void SetToken(token) async&#123; await Storage.getInstance().prefs.setString(\"token\", token);&#125;// è·å–tokenå­—ç¬¦ä¸²String GetToken() &#123; String token = Storage.getInstance().prefs.getString(\"token\"); return token == null ? \"\" : token;&#125;// è·å–æ˜¯å¦ç¬¬ä¸€æ¬¡è¿è¡Œbool isFirst() &#123; var state = Storage.getInstance().prefs.getBool(\"isFirst\"); return state == null ? false : true;&#125;","categories":[{"name":"flutter","slug":"flutter","permalink":"https://guaik.github.io/categories/flutter/"}],"tags":[{"name":"flutter","slug":"flutter","permalink":"https://guaik.github.io/tags/flutter/"},{"name":"SharedPreferences","slug":"SharedPreferences","permalink":"https://guaik.github.io/tags/SharedPreferences/"},{"name":"å•ä¾‹æ¨¡å¼","slug":"å•ä¾‹æ¨¡å¼","permalink":"https://guaik.github.io/tags/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/"},{"name":"åŒæ­¥","slug":"åŒæ­¥","permalink":"https://guaik.github.io/tags/%E5%90%8C%E6%AD%A5/"}]},{"title":"é€’å½’ç®—æ³•ï¼Œluaçš„tableä¸jsonäº’è½¬","slug":"é€’å½’ç®—æ³•ï¼Œluaçš„tableä¸jsonäº’è½¬","date":"2020-04-15T04:10:00.000Z","updated":"2020-05-23T13:43:21.418Z","comments":true,"path":"2020/04/15/é€’å½’ç®—æ³•ï¼Œluaçš„tableä¸jsonäº’è½¬/","link":"","permalink":"https://guaik.github.io/2020/04/15/%E9%80%92%E5%BD%92%E7%AE%97%E6%B3%95%EF%BC%8Clua%E7%9A%84table%E4%B8%8Ejson%E4%BA%92%E8%BD%AC/","excerpt":"","text":"æ ‡é¢˜å‡ ä¹æ˜¯å…³é”®è¯ç»„æˆï¼Œé‚£ä¹ˆè¿™ç¯‡æ–‡ç« ä¼šè®²äº›ä»€ä¹ˆï¼Ÿ é€’å½’ç®—æ³•çš„ä½¿ç”¨ golangè°ƒç”¨luaçš„æ–¹æ³• luaä¸­tableä¸jsonçš„ç›¸äº’è½¬æ¢ é€’å½’ç®—æ³•ç‰¹æ€§å¤„ç†å±‚çº§å…³ç³»çš„ç»“æ„ï¼Œéå†æ•°æ®éå®ƒè«å± å¦‚ä½•è®¾è®¡é€’å½’ å±‚çº§åˆ†ç±»ï¼Œç»Ÿä¸€å‡½æ•°å‚æ•°ä¸è¿”å›å€¼ ä½•æ—¶å¼€å§‹è¿”å› åº”ç”¨å°ç™½èƒ½å¬æ‡‚çš„ï¼šä»€ä¹ˆæ˜¯å±‚çº§å…³ç³»çš„ç»“æ„å‘¢ï¼Ÿåœ¨windowsç³»ç»Ÿä¸­æœ‰ä¸ªâ€œæˆ‘çš„ç”µè„‘â€ï¼Œâ€œæˆ‘çš„ç”µè„‘â€ä¸­è¿˜æœ‰C,D,E,Fç›˜ï¼ŒCç›˜ä¸­è¿˜æœ‰windowsç›®å½•å­˜æ”¾ç³»ç»Ÿæ–‡ä»¶ï¼ŒDç›˜ä¸­è¿˜æœ‰æˆ‘çè—å¤šå¹´çš„ã€æ—¥æœ¬***ç©ºå°å§ã€‘ã€‚æ‰€ä»¥æœ€ç®€å•çš„ç†è§£å°±æ˜¯ä¸€å±‚å¥—ä¸€å±‚çš„å…³ç³»ã€‚ ä¸­ç™½èƒ½å¬æ‡‚çš„ï¼šäºŒå‰æ ‘éå†ï¼Œçˆ¶å­èŠ‚ç‚¹å…³ç³»ã€‚jsonä¸­ä¸€å±‚å±‚çš„èŠ±æ‹¬å·{}ã€‚è¿™äº›éƒ½æ˜¯æ˜æ˜¾çš„å±‚çº§å…³ç³»ã€‚ æ‰€ä»¥æœ¬æ–‡ä¸­å¤„ç†tableä¸jsonçš„è½¬æ¢å°±ä½¿ç”¨é€’å½’ç®—æ³•ã€‚ golangå¦‚ä½•è°ƒç”¨luaçš„æ–¹æ³•luaæ˜¯ä»€ä¹ˆé¦–å…ˆå®ƒæ˜¯ä¸€é—¨è„šæœ¬è¯­è¨€ï¼Œä½†æ˜¯å®ƒç‰¹åˆ«é€‚åˆåµŒå…¥å…¶ä»–çš„è¯­è¨€ä¸­ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆè¦åµŒå…¥å…¶ä»–è¯­è¨€å‘¢ï¼Ÿè‡ªå·±éƒ½æ˜¯ä¸€ä¸ªè¯­è¨€äº†åœ¨åµŒå…¥ä¸ªluaä¸å¤šä½™å—ï¼Ÿ æˆ‘å°±æ‹¿C++ä¸¾ä¸ªæ —å­ï¼ŒC++çš„ç¨‹åºæ¯æ¬¡æ›´æ–°ä»£ç éƒ½æ˜¯éœ€è¦é‡æ–°ç¼–è¯‘é“¾æ¥çš„ï¼Œå“ªæ€•æ”¹åŠ¨ä¸€ç‚¹é€»è¾‘å°±è¦é‡æ–°ç¼–è¯‘æ‰è¡Œã€‚æŸäº›æƒ…å†µä¸‹ç¨‹åºç»å¸¸ä¼šä¿®æ”¹ä¸€äº›ä¸šåŠ¡é€»è¾‘ï¼Œæ¸¸æˆä¸­çš„æ™ºèƒ½çŠ¶æ€æœºï¼Œåœ¨è°ƒè¯•çš„æ—¶å€™æ¯æ¬¡ä¿®æ”¹éƒ½éœ€è¦é‡æ–°ç¼–è¯‘é“¾æ¥å°±å¤ªéº»çƒ¦äº†ï¼Œå¦‚æœæŠŠçŠ¶æ€æœºå†™ä¸ªæ¥å£ç»™luaå»è°ƒç”¨ï¼Œä¿®æ”¹è„šæœ¬å°±å¯ä»¥è°ƒæ•´çŠ¶æ€æœºçš„é€»è¾‘ï¼Œè¿™å¤ªçˆ½äº†ã€‚ å®‰è£…luaçš„ä¾èµ–åŒ… 1go get github.com/yuin/gopher-lua luaçš„è¿è¡Œæ—¶ç¯å¢ƒluaçš„è¿è¡ŒçŠ¶æ€ï¼ˆStateï¼‰å­˜æ”¾ç€è¿è¡Œæ—¶çš„ä¸€äº›å…³é”®æ•°æ®ï¼šè¿è¡Œå †æ ˆï¼Œä¸Šä¸‹æ–‡æ•°æ®ç­‰ï¼ˆè®°ä¸æ¸…äº†è®²å¤šäº†ä½ ä¹Ÿè®°ä¸ä½ï¼‰ï¼Œæ€»ä¹‹ä¸åŒçš„çŠ¶æ€æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œä¸åŒçš„çŠ¶æ€é—´æ•°æ®æ˜¯ä¸å¯è§çš„ï¼Œæ‰€ä»¥å¤šçº¿ç¨‹å®‰å…¨ã€‚ åˆ›å»ºluaçŠ¶æ€ 1env := lua.NewState() golangä¸luaçš„äº¤äº’luaä½œä¸ºä¸€é—¨åµŒå…¥å¼çš„è¯­è¨€ï¼Œæœ‰ä¸ªå¾ˆé‡è¦çš„ç‰¹ç‚¹å°±æ˜¯èƒ½å¤Ÿåœ¨luaä¸­èƒ½å¤Ÿè°ƒç”¨è¢«å¯„ç”Ÿè¯­è¨€çš„å‡½æ•°ï¼ˆå¯„ç”Ÿå…½çœ‹è¿‡å§ï¼Ÿï¼‰ï¼Œè¿™æ ·å°±å®Œæˆäº†è¢«å¯„å®¿çš„è¯­è¨€å¼€æ”¾æ¥å£ï¼Œç„¶åé€šè¿‡luaç¼–å†™è„šæœ¬å°±èƒ½å¤Ÿæ–¹ä¾¿çš„ä¿®æ”¹é€»è¾‘äº†ã€‚ åœ¨luaä¸­æ³¨å†Œæ–°çš„å‡½æ•° 1234567/// è½¬æ¢çš„é€»è¾‘æ˜¯ç”±golangç¼–å†™çš„æä¾›ç»™luaè°ƒç”¨çš„æ¥å£ä»£ç /// luaæœ¬èº«ä¸æ”¯æŒtableä¸jsonäº’è½¬// tableè½¬jsonå­—ç¬¦ä¸²env.SetGlobal(\"jsonMarshal\", env.NewFunction(luaJson.JsonMarshal))// jsonå­—ç¬¦ä¸²è½¬tableenv.SetGlobal(\"jsonUnMarshal\", env.NewFunction(luaJson.JsonUnMarshal)) ç›¸å…³æ¥å£ä»£ç  1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192package jsonimport ( \"encoding/json\" \"github.com/golang/glog\" lua \"github.com/yuin/gopher-lua\")// æ£€æŸ¥Tableæ˜¯å¦ä¸ºListfunc checkList(value lua.LValue) (b bool) &#123; if value.Type().String() == \"table\" &#123; b = true value.(*lua.LTable).ForEach(func(k, v lua.LValue) &#123; if k.Type().String() != \"number\" &#123; b = false return &#125; &#125;) &#125; return&#125;func marshal(data lua.LValue) interface&#123;&#125; &#123; switch data.Type() &#123; case lua.LTTable: if checkList(data) &#123; jdata := make([]interface&#123;&#125;, 0) data.(*lua.LTable).ForEach(func(key, value lua.LValue) &#123; jdata = append(jdata, marshal(value)) &#125;) return jdata &#125; else &#123; jdata := map[string]interface&#123;&#125;&#123;&#125; data.(*lua.LTable).ForEach(func(key, value lua.LValue) &#123; jdata[key.String()] = marshal(value) &#125;) return jdata &#125; case lua.LTNumber: return float64(data.(lua.LNumber)) case lua.LTString: return string(data.(lua.LString)) case lua.LTBool: return bool(data.(lua.LBool)) &#125; return nil&#125;func JsonMarshal(L *lua.LState) int &#123; data := L.ToTable(1) str, err := json.Marshal(marshal(data)) if err != nil &#123; glog.Error(err) &#125; L.Push(lua.LString(str)) return 1&#125;func unmarshal(L *lua.LState, data interface&#123;&#125;) lua.LValue &#123; switch data.(type) &#123; case map[string]interface&#123;&#125;: tb := L.NewTable() for k, v := range data.(map[string]interface&#123;&#125;) &#123; tb.RawSet(lua.LString(k), unmarshal(L, v)) &#125; return tb case []interface&#123;&#125;: tb := L.NewTable() for i, v := range data.([]interface&#123;&#125;) &#123; tb.Insert(i+1, unmarshal(L, v)) &#125; return tb case float64: return lua.LNumber(data.(float64)) case string: return lua.LString(data.(string)) case bool: return lua.LBool(data.(bool)) &#125; return lua.LNil&#125;func JsonUnMarshal(L *lua.LState) int &#123; str := L.ToString(1) jdata := map[string]interface&#123;&#125;&#123;&#125; err := json.Unmarshal([]byte(str), &amp;jdata) if err != nil &#123; glog.Error(err) &#125; L.Push(unmarshal(L, jdata)) return 1&#125; åœ¨luaä¸­è°ƒç”¨golangæä¾›çš„æ¥å£1234567891011121314function processor() data = &#123;&#125; data[\"hello\"]=\"world\" data[\"a\"] = &#123;&#125; data[\"a\"][\"b\"] = \"b\" data[\"a\"][\"c\"] = &#123;1,2,3,4,5,6&#125; res = jsonMarshal(data) res = jsonUnMarshal(res) for k,v in ipairs(res[\"a\"][\"c\"]) do print(k,v) end return trueend","categories":[],"tags":[{"name":"golang","slug":"golang","permalink":"https://guaik.github.io/tags/golang/"},{"name":"é€’å½’","slug":"é€’å½’","permalink":"https://guaik.github.io/tags/%E9%80%92%E5%BD%92/"},{"name":"lua","slug":"lua","permalink":"https://guaik.github.io/tags/lua/"},{"name":"table","slug":"table","permalink":"https://guaik.github.io/tags/table/"},{"name":"json","slug":"json","permalink":"https://guaik.github.io/tags/json/"}]},{"title":"æ¶ˆæ¯é˜Ÿåˆ—åœ¨å‰ç«¯çš„åº”ç”¨","slug":"æ¶ˆæ¯é˜Ÿåˆ—åœ¨å‰ç«¯çš„åº”ç”¨","date":"2020-04-12T16:21:12.000Z","updated":"2020-04-15T04:52:05.609Z","comments":true,"path":"2020/04/13/æ¶ˆæ¯é˜Ÿåˆ—åœ¨å‰ç«¯çš„åº”ç”¨/","link":"","permalink":"https://guaik.github.io/2020/04/13/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%9C%A8%E5%89%8D%E7%AB%AF%E7%9A%84%E5%BA%94%E7%94%A8/","excerpt":"","text":"é˜Ÿåˆ—ä¸å †æ ˆçš„åŒºåˆ«é˜Ÿåˆ—ç”±ä¸€ä¸ªå…¥å£å’Œä¸€ä¸ªå‡ºå£ç»„æˆï¼Œå…ˆè¿›å…ˆå‡ºã€‚å †æ ˆåªæœ‰ä¸€ä¸ªå£ï¼Œåè¿›å…ˆå‡ºã€‚ ç”Ÿäº§æ¶ˆè´¹è€…æ¨¡å‹ä¸é˜Ÿåˆ—é˜Ÿåˆ—æ˜¯å¯ä»¥ç”¨æ¥åšç¼“å†²åŒºä½¿ç”¨çš„ï¼Œå½“çŸ­æ—¶é—´å†…å‡ºç°å¤§é‡æ•°æ®çš„æ—¶å€™ä¼šé€ æˆè½¯ä»¶æˆ–æ•´ä¸ªç³»ç»Ÿçš„ä¸ç¨³å®šï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±å¯ä»¥æŠŠæ•°æ®å…ˆä¸¢åˆ°é˜Ÿåˆ—ä¸­ç¼“å­˜èµ·æ¥ï¼Œç„¶åä»¥åˆé€‚çš„é€Ÿåº¦è·å–å¹¶å¤„ç†æ•°æ®ä¿éšœç³»ç»Ÿçš„ç¨³å®šã€‚è¿™å°±æ˜¯ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹ï¼Œç”Ÿäº§è€…è´Ÿè´£ç”Ÿäº§æ•°æ®è€Œæ¶ˆè´¹è€…è´Ÿè´£å¤„ç†æ•°æ®ã€‚ æ¶ˆæ¯é˜Ÿåˆ—åœ¨åç«¯å¼€å‘çš„åº”ç”¨ ç”µå•†å¹³å°æœ‰ä¸€é¡¹ä¸šåŠ¡ï¼šç§’æ€æ´»åŠ¨ã€‚åœ¨æçŸ­çš„æ—¶é—´å†…æœåŠ¡å™¨å°†ä¼šæ”¶åˆ°å¤§é‡å•†å“çš„è´­ä¹°è¯·æ±‚ï¼Œå¦‚ä½•é™ä½ä¸šåŠ¡æœåŠ¡å™¨å—åˆ°çš„å†²å‡»å‘¢ï¼Ÿæˆ‘ä»¬ä¼šä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œå‰Šå³°å¤„ç†ã€‚å¸¸ç”¨çš„åç«¯æ¶ˆæ¯é˜Ÿåˆ—æœ‰ï¼šKafkaã€RabbitMQã€ActiveMQã€ZeroMQã€‚ æ¶ˆæ¯é˜Ÿåˆ—é€šå¸¸éƒ½æ”¯æŒå¤šä¸ªè®¢é˜…è€…ï¼Œåˆ©ç”¨è¿™ä¸ªç‰¹æ€§å¯ä»¥å®ç°ä¸€äº›æœåŠ¡çš„è´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚ ğŸ“æ­£é¢˜ï¼šé˜Ÿåˆ—åœ¨å‰ç«¯çš„åº”ç”¨é™é€Ÿï¼Œè®©ç•Œé¢æ›´æµç•…ä¸€äº›åœ¨èŠå¤©å®¤åº”ç”¨ä¸­å°‘åˆ™0äººå¤šåˆ™ä¸Šä¸‡äººï¼Œåœ¨æ”¶åˆ°å¤§é‡å³æ—¶é€šè®¯æ¶ˆæ¯æ—¶å¦‚æœä¸åŠ å¤„ç†å…¨éƒ¨æ‹¿å»åœ¨ç•Œé¢åšæ¸²æŸ“é‚£ä¹ˆè½»åˆ™ç•Œé¢å¡é¡¿é‡åˆ™APPå¡æ­»ã€‚å¾®ä¿¡å°ç¨‹åºç»™å‡ºçš„è°ƒç”¨setDataçš„æœ€ä½³æ—¶é—´é—´éš”ä¸º20msï¼Œä¹Ÿå°±æ˜¯å¦‚æœæŠŠæ•°æ®åˆ·æ–°çš„é¢‘ç‡æ§åˆ¶åœ¨20msåˆ·æ–°ä¸€æ¬¡æ˜¯æ›´åˆç†çš„ã€‚æ‰€ä»¥æ¶ˆè´¹è€…åº”è¯¥æ¯éš”20msè·å–å¹¶å¤„ç†ä¸€æ¡æ•°æ®ä¿éšœç•Œé¢çš„ä¸å¡ã€‚ å‡å°‘æ²¡å¿…è¦çš„å†…å­˜æµªè´¹è¿™æ ·é™ä½äº†æ¶ˆè´¹çš„é€Ÿåº¦ï¼Œä¼šå¯¼è‡´é˜Ÿåˆ—ä¸­çš„æ•°æ®ç§¯å‹ä¸¥é‡ï¼Œå¤§é‡æ¶ˆè€—å†…å­˜èµ„æºï¼Œä¸€æ¡æ¶ˆæ¯åœ¨å‡ åˆ†é’Ÿåè¢«çœ‹åˆ°ä¹Ÿæ˜¯å¯èƒ½çš„ï¼Œé‚£å¦‚ä½•å¤„ç†å‘¢ï¼Ÿå‡è®¾1ç§’é’Ÿæ”¶åˆ°äº†1000æ¡èŠå¤©æ¶ˆæ¯ï¼Œé‚£ä¹ˆè¿™äº›æ¶ˆæ¯éœ€è¦å…¨éƒ¨æ˜¾ç¤ºå—ï¼Ÿè‡³å°‘æˆ‘çš„çœ¼ç›æ˜¯æ¥ä¸åŠçœ‹å®Œçš„ï¼Œæ‰€ä»¥å¯ä»¥è®¾å®šé˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦ï¼Œè¶…å‡ºçš„æ¶ˆæ¯å…¨éƒ¨ä¸¢å¼ƒï¼ˆé•¿åº¦æ ¹æ®å®é™…åœºæ™¯è®¾å®šï¼‰ã€‚ ä¿éšœé‡è¦çš„æ¶ˆæ¯å¿«é€Ÿæ˜¾ç¤ºå¹¶ä¸”å¿…é¡»æ˜¾ç¤ºæœ‰ä¸ªç”¨æˆ·åœ¨ç›´æ’­é—´åˆ·äº†ä¸ªç«ç®­ï¼Œå—¯ï¼Œç«ç®­è¢«å¤–æ˜ŸäººåŠ«èµ°ä¸è§äº†ï¼Œä¸–ç•Œæœªè§£ä¹‹è°œå‡ºç°ã€‚æˆ–è€…ç”±äºæ•°æ®çš„ç§¯å‹ç«ç®­1åˆ†é’Ÿåç»ˆäºå‡ºç°äº†ï¼Œä¸»æ’­éƒ½ä¸‹æ’­äº†ã€‚ ä¸ºäº†é¿å…ä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦VIPé˜Ÿåˆ—ï¼Œå¦‚æœè¯´æ™®é€šèŠå¤©æ¶ˆæ¯æ”¾å…¥æ™®é€šé˜Ÿåˆ—ï¼Œé‚£ä¹ˆç°é‡‘ç¤¼ç‰©çš„å°±è¦æ”¾å…¥VIPé˜Ÿåˆ—æ’é˜Ÿäº†ï¼Œå¹¶ä¸”ä½¿å‘½å¿…è¾¾ï¼Œæœ‰ä¸€æ¡æ˜¾ç¤ºä¸€æ¡ã€‚è¿™ä¸ªå®ç°ä¹Ÿå¾ˆå®¹æ˜“ï¼ŒVIPé˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦ä¸ºâˆå¤§ï¼Œä¸åˆ¤æ–­é•¿åº¦å°±è¡Œäº†ï¼Œè™½ç„¶ä¹Ÿè¾¾ä¸åˆ°1ç§’1000ä¸ªç«ç®­çš„é‡ï¼Œä½†é±¼ä¸¸å°±è¯´ä¸å®šäº†ã€‚ç”±äºVIPé˜Ÿåˆ—æ˜¯ç‹¬ç«‹äºæ™®é€šé˜Ÿåˆ—çš„ï¼Œæ‰€ä»¥æ¶ˆæ¯ä¸ä¼šè¢«æ’åœ¨æ™®é€šé˜Ÿåˆ—çš„æœ«å°¾ï¼Œå®ç°äº†æ’é˜Ÿçš„åŠŸèƒ½ï¼Œé€šå¸¸è¿™ä¸ªé˜Ÿåˆ—çš„é‡ä¸ä¼šç‰¹åˆ«å¤§æ‰€ä»¥èƒ½å¤Ÿå¿«é€Ÿæ˜¾ç¤ºå‡ºæ¥ã€‚ æ•°æ®çš„èåˆï¼Œå±å¹•èƒ½æ˜¾ç¤ºNä¸ªåˆ—è¡¨é¡¹å°±åˆ·æ–°Næ¡æ•°æ®å¦‚æœä¸€ä¸ªå±å¹•åªèƒ½æ˜¾ç¤º10ä¸ªåˆ—è¡¨é¡¹ï¼Œä½ æ¯æ¬¡æœ‰å¿…è¦åˆ·æ–°10000æ¡æ•°æ®å—ï¼Ÿè¿˜ä¸å¤Ÿå¡å—ï¼Ÿæ‰€ä»¥å½“å±å¹•åªèƒ½æ˜¾ç¤º10ä¸ªåˆ—è¡¨é¡¹çš„æ—¶å€™æ¯æ¬¡åªåˆ·æ–°æœ€æ–°çš„100æ¡æ•°æ®ï¼Œæ›´å¤šçš„è¯·çœ‹èŠå¤©è®°å½•ã€‚è¿™æ ·å°±åˆå¤šäº†ä¸€ä¸ªåˆ—è¡¨ç”¨æ¥å­˜å‚¨å¯è§æ•°æ®äº†ï¼Œè¿™ä¸ªåˆ—è¡¨åªå¹²ä¸€ä»¶äº‹ï¼Œèåˆæ™®é€šé˜Ÿåˆ—å’ŒVIPé˜Ÿåˆ—çš„æ¶ˆæ¯ç”¨äºsetDataæ—¶åˆ·æ–°åˆ°å±å¹•ä¸Šçš„æ•°æ®ã€‚ ğŸš€å®æˆ˜é¡¹ç›®ï¼šgqueuehttps://github.com/GUAIK-ORG/gqueue","categories":[],"tags":[{"name":"typescript","slug":"typescript","permalink":"https://guaik.github.io/tags/typescript/"},{"name":"javascript","slug":"javascript","permalink":"https://guaik.github.io/tags/javascript/"},{"name":"å‰ç«¯","slug":"å‰ç«¯","permalink":"https://guaik.github.io/tags/%E5%89%8D%E7%AB%AF/"},{"name":"é˜Ÿåˆ—","slug":"é˜Ÿåˆ—","permalink":"https://guaik.github.io/tags/%E9%98%9F%E5%88%97/"}]},{"title":"åŠ æƒéšæœºç®—æ³•","slug":"åŠ æƒéšæœºç®—æ³•","date":"2020-04-12T14:02:06.000Z","updated":"2020-04-12T14:26:38.217Z","comments":true,"path":"2020/04/12/åŠ æƒéšæœºç®—æ³•/","link":"","permalink":"https://guaik.github.io/2020/04/12/%E5%8A%A0%E6%9D%83%E9%9A%8F%E6%9C%BA%E7%AE%97%E6%B3%95/","excerpt":"","text":"ç™½è¯åŸç†ç”Ÿæ´»ä¸­æœ€å¸¸è§çš„ä¸€ä¸ªä¾‹å­ï¼šç°åœ¨æœ‰4ä¸ªçº¢çƒå’Œ6ä¸ªé»‘çƒï¼ŒæŠŠè¿™10ä¸ªçƒæ”¾å…¥åˆ°ä¸€ä¸ªä¸é€æ˜çš„è¢‹å­ä¸­æ‰“ä¹±ï¼Œé‚£ä¹ˆå»è¢‹å­ä¸­æ‹¿åˆ°çº¢çƒçš„æ¦‚ç‡æ˜¯4/10ï¼Œæ‹¿åˆ°é»‘çƒçš„æ¦‚ç‡æ˜¯6/10ï¼Œä¹Ÿå¯ä»¥è¯´è¢‹å­åˆ†é…ç»™æˆ‘çº¢çƒçš„æ¦‚ç‡æ˜¯4/10ï¼Œåˆ†é…ç»™æˆ‘é»‘çƒçš„æ¦‚ç‡æ˜¯6/10ã€‚ å®é™…åº”ç”¨ ç½‘å…³æœåŠ¡å™¨é€šå¸¸éƒ½ä¼šé€šè¿‡è´Ÿè½½å‡è¡¡å»åˆ†æ‘Šè®¡ç®—å‹åŠ›ï¼Œæœ‰çš„æœåŠ¡å™¨æ€§èƒ½ä¼šå¥½ä¸€äº›ï¼Œæœ‰çš„ä¼šå·®ä¸€äº›ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡æƒé‡é…æ¯”çš„å½¢å¼å°†è¾ƒå¤§çš„è®¡ç®—å‹åŠ›ç»™åˆ°æ€§èƒ½è¾ƒå¥½çš„æœåŠ¡å™¨ã€‚ å½“æŸå°æœåŠ¡å™¨çªç„¶å‡ºç°æ•…éšœæ—¶ï¼Œå¾®æœåŠ¡æ¶æ„å¯ä»¥é€šè¿‡æœåŠ¡æ³¨å†Œå‘ç°å°†æ•…éšœçš„æœåŠ¡å™¨ç§»é™¤ï¼Œå¦‚æœæ˜¯ç½‘å…³æœåŠ¡å™¨çš„è¯æˆ‘ä»¬å¯ä»¥å°†è´Ÿè½½å‡è¡¡çš„æƒé‡ç½®0ã€‚ å®ç°ä»£ç 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950// å®ä¾‹å¯¹è±¡type Object struct &#123; Weight int // æƒé‡ Object interface&#123;&#125; // æœåŠ¡å¯¹è±¡&#125;// è°ƒåº¦å¯¹è±¡type Dispatch struct &#123; Sources []*Object // æ‰€æœ‰æœåŠ¡å¯¹è±¡ SLB []*Object // è´Ÿè½½å‡è¡¡ç”Ÿæˆçš„å¯¹è±¡ TotalWeight int // æ€»æƒé‡&#125;// åˆå§‹åŒ–func (dispatch *Dispatch) Init() (err error) &#123; dispatch.Sources = make([]*LiveObject, 0) dispatch.SLB = make([]*LiveObject, 0) dispatch.TotalWeight = 0 return&#125;// é‡æ–°ç”Ÿæˆè´Ÿè½½å‡è¡¡é˜Ÿåˆ—func (dispatch *Dispatch) reGenSLBArray() &#123; dispatch.SLB = make([]*LiveObject, 0) dispatch.TotalWeight = 0 for _, item := range dispatch.Sources &#123; dispatch.TotalWeight += item.Weight for i := 0; i &lt; item.Weight; i++ &#123; dispatch.SLB = append(dispatch.SLB, item) &#125; &#125; // éšæœºæ’åˆ—é¡ºåº rand.Seed(time.Now().UnixNano()) rand.Shuffle(dispatch.TotalWeight, func(i, j int) &#123; dispatch.SLB[i], dispatch.SLB[j] = dispatch.SLB[j], dispatch.SLB[i] &#125;)&#125;// æ·»åŠ æœåŠ¡å¯¹è±¡func (dispatch *Dispatch) AddObject(object *Object) &#123; dispatch.Sources = append(dispatch.Sources, object) dispatch.reGenSLBArray()&#125;// è·å–å¯¹è±¡func (dispatch *Dispatch) GetObject() (object *Object) &#123; rand.Seed(time.Now().UnixNano()) return dispatch.SLB[rand.Intn(dispatch.TotalWeight)]&#125;","categories":[],"tags":[{"name":"golang","slug":"golang","permalink":"https://guaik.github.io/tags/golang/"},{"name":"è´Ÿè½½å‡è¡¡","slug":"è´Ÿè½½å‡è¡¡","permalink":"https://guaik.github.io/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"}]},{"title":"åŸºäºRedisçš„åˆ†å¸ƒå¼é”","slug":"åŸºäºRedisçš„åˆ†å¸ƒå¼é”","date":"2020-04-12T12:38:39.000Z","updated":"2020-04-12T15:07:03.488Z","comments":true,"path":"2020/04/12/åŸºäºRedisçš„åˆ†å¸ƒå¼é”/","link":"","permalink":"https://guaik.github.io/2020/04/12/%E5%9F%BA%E4%BA%8ERedis%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/","excerpt":"","text":"ä¸ºä»€ä¹ˆè¦ä½¿ç”¨åˆ†å¸ƒå¼é”ä¸¾ä¸ªæ —å­ï¼Œåœ¨è®¾è®¡ç›´æ’­é—´å¼€æ’­æµç¨‹çš„æ—¶å€™ä¼šæ‰§è¡Œå¾ˆå¤šåˆå§‹åŒ–çš„æ“ä½œï¼Œä¹Ÿä¼šåœ¨ç¼“å­˜ä¸­åˆ›å»ºæœ¬æ¬¡ç›´æ’­çš„è®°å½•æ•°æ®ï¼Œä¸ºäº†é¿å…ä¸»æ’­è¯¯æ“ä½œåŒæ—¶æ‰§è¡Œå¼€æ’­æµç¨‹å¤šæ¬¡ï¼Œåœ¨å¼€æ’­æˆåŠŸåä¼šè®¾ç½®å¼€æ’­çŠ¶æ€ï¼Œå¼€æ’­æ—¶åˆ¤æ–­çŠ¶æ€ä¸ºå·²å¼€æ’­åˆ™ä¸å¤„ç†ï¼Œç›´æ’­ç³»ç»Ÿæ˜¯å¤šå®ä¾‹éƒ¨ç½²çš„ï¼Œä¸ºäº†ä¿æŠ¤å¼€æ’­çŠ¶æ€ï¼Œéœ€è¦åšåˆ°åŒä¸€æ—¶é—´åªèƒ½ç”±ä¸€å°æœåŠ¡å™¨å¤„ç†å¼€æ’­æµç¨‹ï¼Œè¿™æ—¶å€™å°±ä¼šç”¨åˆ°åˆ†å¸ƒå¼é”è¿›è¡ŒåŠ é”ä¿æŠ¤ã€‚ çº¿ç¨‹é”ä¸åˆ†å¸ƒå¼é”é”çš„æ„ä¹‰åœ¨äºä¿æŠ¤å…¨å±€å¯è§å¯¹è±¡ã€‚åœ¨å•è¿›ç¨‹ä¸­ä½¿ç”¨å¤šçº¿ç¨‹æ—¶ä¼šé€šè¿‡çº¿ç¨‹é”å»ä¿æŠ¤å½“å‰è¿›ç¨‹ä¸­çš„å…¨å±€å¯¹è±¡ï¼ˆæŸäº›æƒ…å†µå¯ç”¨åŸå­æ“ä½œï¼‰ã€‚åˆ†å¸ƒå¼ç³»ç»Ÿå¯ç†è§£ä¸ºå¤šè¿›ç¨‹ç³»ç»Ÿï¼Œçº¿ç¨‹é”æ— æ³•é”ä½å…¶ä»–è¿›ç¨‹ä¸­çš„æ‰§è¡Œæµç¨‹ï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªå…¨å±€çš„é”æ¥ç®¡æ§æ‰€æœ‰è¿›ç¨‹ä¸­çš„æ‰§è¡Œæµç¨‹ï¼ˆå¦‚æœç›¸åŒåç§°çš„é”å¤„äºä¸Šé”çŠ¶æ€åˆ™ç­‰å¾…ï¼‰ã€‚ Redisä¸SetNXRedisæ˜¯å•è¿›ç¨‹ç³»ç»Ÿï¼Œå®ƒçš„SetNXæ˜¯ä¸ªåŸå­æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸¤ç‚¹æ¥å®ç°åˆ†å¸ƒå¼é”ã€‚å¦‚æœSetNXæ‰§è¡ŒæˆåŠŸåˆ™æ„å‘³ç€æ‹¿åˆ°äº†é”ï¼Œç›¸åæ‰§è¡Œå¤±è´¥åˆ™å¾ªç¯ç­‰å¾…æ‹¿é”æˆ–è¶…æ—¶é€€å‡ºã€‚ è®¾è®¡æ³¨æ„äº‹é¡¹1ã€ä¸ºäº†é¿å…å•æŒæœ‰é”çš„è¿›ç¨‹å¥”æºƒè€Œæ— æ³•é‡Šæ”¾é”ï¼Œæ‰€ä»¥å¿…é¡»èƒ½å¤Ÿä¸ºé”è®¾å®šè¿‡æœŸæ—¶é—´è‡ªåŠ¨é‡Šæ”¾é”èµ„æºã€‚ 2ã€ä½¿ç”¨TTLæ£€æŸ¥é”æ˜¯å¦æˆåŠŸçš„è¢«è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå¦‚æœè¿”å›-1ï¼ˆæœªè¢«è®¾ç½®ï¼‰çš„è¯ï¼Œä½¿ç”¨Expireä¸ºå…¶è®¾å®šè¿‡æœŸæ—¶é—´ã€‚ 3ã€åœ¨é‡Šæ”¾é”çš„æ—¶å€™éœ€è¦ä½¿ç”¨Watchå‘½ä»¤ï¼Œç¡®ä¿ç›‘æµ‹çš„å€¼åœ¨äº‹åŠ¡æ‰§è¡Œæ—¶æ—¶æœªè¢«æ”¹å˜ï¼Œå¦‚æœå…¶ä»–è¿›ç¨‹ä¿®æ”¹äº†é”ï¼Œä¼šè§¦å‘äº‹åŠ¡å¼‚å¸¸ï¼Œç„¶åé‡æ–°æ‰§è¡ŒWatchã€‚ åˆ†äº«ä¸€ä¸ªæˆ‘å†™çš„Rediså°è£…ç±»ï¼Œä»…å®ç°äº†è¿æ¥å’Œé” 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374package daoimport ( \"time\" \"github.com/go-redis/redis/v7\" uuid \"github.com/satori/go.uuid\")type Rds struct &#123; Client *redis.Client AcquireTimeout int32 LockTimeout int32&#125;func NewRds(host, passwd string, db int) (rds *Rds, err error) &#123; rdsOpt := &amp;redis.Options&#123; Addr: host, Password: passwd, DB: db, &#125; client := redis.NewClient(rdsOpt) _, err = client.Ping().Result() if err != nil &#123; return &#125; rds = &amp;Rds&#123;Client: client, AcquireTimeout: 10, LockTimeout: 10&#125; return&#125;func (r *Rds) AcquireLockWithTimeout(key string) (identifier string, b bool) &#123; identifier = uuid.NewV4().String() lockname := \"lock:\" + key end := time.Now().Add(time.Second * time.Duration(r.AcquireTimeout)) for time.Now().Before(end) &#123; if r.Client.SetNX(lockname, identifier, time.Second*time.Duration(r.LockTimeout)).Val() &#123; // å¦‚æœkeyä¸å­˜åœ¨ï¼Œå¹¶æˆåŠŸè®¾ç½®äº†key b = true return &#125; else if r.Client.TTL(lockname).Val() == -1 &#123; // å¦‚æœkeyå­˜åœ¨ï¼Œä½†æ˜¯æ²¡æœ‰å‰©ä½™æ—¶é—´ r.Client.Expire(lockname, time.Second*time.Duration(r.LockTimeout)) &#125; time.Sleep(time.Microsecond) &#125; return&#125;func (r *Rds) ReleaseLock(key, identifier string) (b bool) &#123; lockname := \"lock:\" + key txf := func(tx *redis.Tx) error &#123; v, err := tx.Get(lockname).Result() if err != nil &#123; return err &#125; _, err = tx.Pipelined(func(pipe redis.Pipeliner) error &#123; if v == identifier &#123; pipe.Del(lockname) b = true &#125; return nil &#125;) return err &#125; for &#123; err := r.Client.Watch(txf, lockname) if err == nil &#123; break &#125; else if err == redis.TxFailedErr &#123; glog.Error(err) &#125; &#125; return&#125;","categories":[],"tags":[{"name":"golang","slug":"golang","permalink":"https://guaik.github.io/tags/golang/"},{"name":"redis","slug":"redis","permalink":"https://guaik.github.io/tags/redis/"},{"name":"åˆ†å¸ƒå¼é”","slug":"åˆ†å¸ƒå¼é”","permalink":"https://guaik.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"}]}],"categories":[{"name":"flutter","slug":"flutter","permalink":"https://guaik.github.io/categories/flutter/"}],"tags":[{"name":"rust","slug":"rust","permalink":"https://guaik.github.io/tags/rust/"},{"name":"æœºå™¨å­¦ä¹ ","slug":"æœºå™¨å­¦ä¹ ","permalink":"https://guaik.github.io/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/"},{"name":"æœ´ç´ è´å¶æ–¯","slug":"æœ´ç´ è´å¶æ–¯","permalink":"https://guaik.github.io/tags/%E6%9C%B4%E7%B4%A0%E8%B4%9D%E5%8F%B6%E6%96%AF/"},{"name":"mongodb","slug":"mongodb","permalink":"https://guaik.github.io/tags/mongodb/"},{"name":"çˆ¬è™«","slug":"çˆ¬è™«","permalink":"https://guaik.github.io/tags/%E7%88%AC%E8%99%AB/"},{"name":"éªŒè¯","slug":"éªŒè¯","permalink":"https://guaik.github.io/tags/%E9%AA%8C%E8%AF%81/"},{"name":"flutter","slug":"flutter","permalink":"https://guaik.github.io/tags/flutter/"},{"name":"SharedPreferences","slug":"SharedPreferences","permalink":"https://guaik.github.io/tags/SharedPreferences/"},{"name":"å•ä¾‹æ¨¡å¼","slug":"å•ä¾‹æ¨¡å¼","permalink":"https://guaik.github.io/tags/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/"},{"name":"åŒæ­¥","slug":"åŒæ­¥","permalink":"https://guaik.github.io/tags/%E5%90%8C%E6%AD%A5/"},{"name":"golang","slug":"golang","permalink":"https://guaik.github.io/tags/golang/"},{"name":"é€’å½’","slug":"é€’å½’","permalink":"https://guaik.github.io/tags/%E9%80%92%E5%BD%92/"},{"name":"lua","slug":"lua","permalink":"https://guaik.github.io/tags/lua/"},{"name":"table","slug":"table","permalink":"https://guaik.github.io/tags/table/"},{"name":"json","slug":"json","permalink":"https://guaik.github.io/tags/json/"},{"name":"typescript","slug":"typescript","permalink":"https://guaik.github.io/tags/typescript/"},{"name":"javascript","slug":"javascript","permalink":"https://guaik.github.io/tags/javascript/"},{"name":"å‰ç«¯","slug":"å‰ç«¯","permalink":"https://guaik.github.io/tags/%E5%89%8D%E7%AB%AF/"},{"name":"é˜Ÿåˆ—","slug":"é˜Ÿåˆ—","permalink":"https://guaik.github.io/tags/%E9%98%9F%E5%88%97/"},{"name":"è´Ÿè½½å‡è¡¡","slug":"è´Ÿè½½å‡è¡¡","permalink":"https://guaik.github.io/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"},{"name":"redis","slug":"redis","permalink":"https://guaik.github.io/tags/redis/"},{"name":"åˆ†å¸ƒå¼é”","slug":"åˆ†å¸ƒå¼é”","permalink":"https://guaik.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"}]}