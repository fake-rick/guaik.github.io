{"meta":{"title":"æ€ªå®¢çš„Blog","subtitle":"åˆ†äº«ä¸€äº›é»‘ç§‘æŠ€","description":"","author":"guaik","url":"https://guaik.github.io","root":"/"},"pages":[{"title":"","date":"2020-04-12T15:26:27.457Z","updated":"2020-04-12T11:12:33.055Z","comments":false,"path":"tags/index.html","permalink":"https://guaik.github.io/tags/index.html","excerpt":"","text":""},{"title":"","date":"2020-04-12T15:26:27.457Z","updated":"2020-04-12T11:13:05.148Z","comments":false,"path":"categories/index.html","permalink":"https://guaik.github.io/categories/index.html","excerpt":"","text":""}],"posts":[{"title":"æ¶ˆæ¯é˜Ÿåˆ—åœ¨å‰ç«¯çš„åº”ç”¨","slug":"æ¶ˆæ¯é˜Ÿåˆ—åœ¨å‰ç«¯çš„åº”ç”¨","date":"2020-04-12T16:21:12.000Z","updated":"2020-04-12T17:37:37.504Z","comments":true,"path":"2020/04/13/æ¶ˆæ¯é˜Ÿåˆ—åœ¨å‰ç«¯çš„åº”ç”¨/","link":"","permalink":"https://guaik.github.io/2020/04/13/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%9C%A8%E5%89%8D%E7%AB%AF%E7%9A%84%E5%BA%94%E7%94%A8/","excerpt":"","text":"é˜Ÿåˆ—ä¸å †æ ˆçš„åŒºåˆ«é˜Ÿåˆ—ç”±ä¸€ä¸ªå…¥å£å’Œä¸€ä¸ªå‡ºå£ç»„æˆï¼Œå…ˆè¿›å…ˆå‡ºã€‚å †æ ˆåªæœ‰ä¸€ä¸ªå£ï¼Œåè¿›å…ˆå‡ºã€‚ ç”Ÿäº§æ¶ˆè´¹è€…æ¨¡å‹ä¸é˜Ÿåˆ—é˜Ÿåˆ—æ˜¯å¯ä»¥ç”¨æ¥åšç¼“å†²åŒºä½¿ç”¨çš„ï¼Œå½“çŸ­æ—¶é—´å†…å‡ºç°å¤§é‡æ•°æ®çš„æ—¶å€™ä¼šé€ æˆè½¯ä»¶æˆ–æ•´ä¸ªç³»ç»Ÿçš„ä¸ç¨³å®šï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±å¯ä»¥æŠŠæ•°æ®å…ˆä¸¢åˆ°é˜Ÿåˆ—ä¸­ç¼“å­˜èµ·æ¥ï¼Œç„¶åä»¥åˆé€‚çš„é€Ÿåº¦è·å–å¹¶å¤„ç†æ•°æ®ä¿éšœç³»ç»Ÿçš„ç¨³å®šã€‚è¿™å°±æ˜¯ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹ï¼Œç”Ÿäº§è€…è´Ÿè´£ç”Ÿäº§æ•°æ®è€Œæ¶ˆè´¹è€…è´Ÿè´£å¤„ç†æ•°æ®ã€‚ æ¶ˆæ¯é˜Ÿåˆ—åœ¨åç«¯å¼€å‘çš„åº”ç”¨ ç”µå•†å¹³å°æœ‰ä¸€é¡¹ä¸šåŠ¡ï¼šç§’æ€æ´»åŠ¨ã€‚åœ¨æçŸ­çš„æ—¶é—´å†…æœåŠ¡å™¨å°†ä¼šæ”¶åˆ°å¤§é‡å•†å“çš„è´­ä¹°è¯·æ±‚ï¼Œå¦‚ä½•é™ä½ä¸šåŠ¡æœåŠ¡å™¨å—åˆ°çš„å†²å‡»å‘¢ï¼Ÿæˆ‘ä»¬ä¼šä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œå‰Šå³°å¤„ç†ã€‚å¸¸ç”¨çš„åç«¯æ¶ˆæ¯é˜Ÿåˆ—æœ‰ï¼šKafkaã€RabbitMQã€ActiveMQã€ZeroMQã€‚ æ¶ˆæ¯é˜Ÿåˆ—é€šå¸¸éƒ½æ”¯æŒå¤šä¸ªè®¢é˜…è€…ï¼Œåˆ©ç”¨è¿™ä¸ªç‰¹æ€§å¯ä»¥å®ç°ä¸€äº›æœåŠ¡çš„è´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚ ğŸ“æ­£é¢˜ï¼šé˜Ÿåˆ—åœ¨å‰ç«¯çš„åº”ç”¨é™é€Ÿï¼Œè®©ç•Œé¢æ›´æµç•…ä¸€äº›åœ¨èŠå¤©å®¤åº”ç”¨ä¸­å°‘åˆ™0äººå¤šåˆ™ä¸Šä¸‡äººï¼Œåœ¨æ”¶åˆ°å¤§é‡å³æ—¶é€šè®¯æ¶ˆæ¯æ—¶å¦‚æœä¸åŠ å¤„ç†å…¨éƒ¨æ‹¿å»åœ¨ç•Œé¢åšæ¸²æŸ“é‚£ä¹ˆè½»åˆ™ç•Œé¢å¡é¡¿é‡åˆ™APPå¡æ­»ã€‚å¾®ä¿¡å°ç¨‹åºç»™å‡ºçš„è°ƒç”¨setDataçš„æœ€ä½³æ—¶é—´é—´éš”ä¸º20msï¼Œä¹Ÿå°±æ˜¯å¦‚æœæŠŠæ•°æ®åˆ·æ–°çš„é¢‘ç‡æ§åˆ¶åœ¨20msåˆ·æ–°ä¸€æ¬¡æ˜¯æ›´åˆç†çš„ã€‚æ‰€ä»¥æ¶ˆè´¹è€…åº”è¯¥æ¯éš”20msè·å–å¹¶å¤„ç†ä¸€æ¡æ•°æ®ä¿éšœç•Œé¢çš„ä¸å¡ã€‚ å‡å°‘æ²¡å¿…è¦çš„å†…å­˜æµªè´¹è¿™æ ·é™ä½äº†æ¶ˆè´¹çš„é€Ÿåº¦ï¼Œä¼šå¯¼è‡´é˜Ÿåˆ—ä¸­çš„æ•°æ®ç§¯å‹ä¸¥é‡ï¼Œå¤§é‡æ¶ˆè€—å†…å­˜èµ„æºï¼Œä¸€æ¡æ¶ˆæ¯åœ¨å‡ åˆ†é’Ÿåè¢«çœ‹åˆ°ä¹Ÿæ˜¯å¯èƒ½çš„ï¼Œé‚£å¦‚ä½•å¤„ç†å‘¢ï¼Ÿå‡è®¾1ç§’é’Ÿæ”¶åˆ°äº†1000æ¡èŠå¤©æ¶ˆæ¯ï¼Œé‚£ä¹ˆè¿™äº›æ¶ˆæ¯éœ€è¦å…¨éƒ¨æ˜¾ç¤ºå—ï¼Ÿè‡³å°‘æˆ‘çš„çœ¼ç›æ˜¯æ¥ä¸åŠçœ‹å®Œçš„ï¼Œæ‰€ä»¥å¯ä»¥è®¾å®šé˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦ï¼Œè¶…å‡ºçš„æ¶ˆæ¯å…¨éƒ¨ä¸¢å¼ƒï¼ˆé•¿åº¦æ ¹æ®å®é™…åœºæ™¯è®¾å®šï¼‰ã€‚ ä¿éšœé‡è¦çš„æ¶ˆæ¯å¿«é€Ÿæ˜¾ç¤ºå¹¶ä¸”å¿…é¡»æ˜¾ç¤ºæœ‰ä¸ªç”¨æˆ·åœ¨ç›´æ’­é—´åˆ·äº†ä¸ªç«ç®­ï¼Œå—¯ï¼Œç«ç®­è¢«å¤–æ˜ŸäººåŠ«èµ°ä¸è§äº†ï¼Œä¸–ç•Œæœªè§£ä¹‹è°œå‡ºç°ã€‚æˆ–è€…ç”±äºæ•°æ®çš„ç§¯å‹ç«ç®­1åˆ†é’Ÿåç»ˆäºå‡ºç°äº†ï¼Œä¸»æ’­éƒ½ä¸‹æ’­äº†ã€‚ ä¸ºäº†é¿å…ä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦VIPé˜Ÿåˆ—ï¼Œå¦‚æœè¯´æ™®é€šèŠå¤©æ¶ˆæ¯æ”¾å…¥æ™®é€šé˜Ÿåˆ—ï¼Œé‚£ä¹ˆç°é‡‘ç¤¼ç‰©çš„å°±è¦æ”¾å…¥VIPé˜Ÿåˆ—æ’é˜Ÿäº†ï¼Œå¹¶ä¸”ä½¿å‘½å¿…è¾¾ï¼Œæœ‰ä¸€æ¡æ˜¾ç¤ºä¸€æ¡ã€‚è¿™ä¸ªå®ç°ä¹Ÿå¾ˆå®¹æ˜“ï¼ŒVIPé˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦ä¸ºâˆå¤§ï¼Œä¸åˆ¤æ–­é•¿åº¦å°±è¡Œäº†ï¼Œè™½ç„¶ä¹Ÿè¾¾ä¸åˆ°1ç§’1000ä¸ªç«ç®­çš„é‡ï¼Œä½†é±¼ä¸¸å°±è¯´ä¸å®šäº†ã€‚ç”±äºVIPé˜Ÿåˆ—æ˜¯ç‹¬ç«‹äºæ™®é€šé˜Ÿåˆ—çš„ï¼Œæ‰€ä»¥æ¶ˆæ¯ä¸ä¼šè¢«æ’åœ¨æ™®é€šé˜Ÿåˆ—çš„æœ«å°¾ï¼Œå®ç°äº†æ’é˜Ÿçš„åŠŸèƒ½ï¼Œé€šå¸¸è¿™ä¸ªé˜Ÿåˆ—çš„é‡ä¸ä¼šç‰¹åˆ«å¤§æ‰€ä»¥èƒ½å¤Ÿå¿«é€Ÿæ˜¾ç¤ºå‡ºæ¥ã€‚ æ•°æ®çš„èåˆï¼Œå±å¹•èƒ½æ˜¾ç¤ºNä¸ªåˆ—è¡¨é¡¹å°±åˆ·æ–°Næ¡æ•°æ®å¦‚æœä¸€ä¸ªå±å¹•åªèƒ½æ˜¾ç¤º10ä¸ªåˆ—è¡¨é¡¹ï¼Œä½ æ¯æ¬¡æœ‰å¿…è¦åˆ·æ–°10000æ¡æ•°æ®å—ï¼Ÿè¿˜ä¸å¤Ÿå¡å—ï¼Ÿæ‰€ä»¥å½“å±å¹•åªèƒ½æ˜¾ç¤º10ä¸ªåˆ—è¡¨é¡¹çš„æ—¶å€™æ¯æ¬¡åªåˆ·æ–°æœ€æ–°çš„100æ¡æ•°æ®ï¼Œæ›´å¤šçš„è¯·çœ‹èŠå¤©è®°å½•ã€‚è¿™æ ·å°±åˆå¤šäº†ä¸€ä¸ªåˆ—è¡¨ç”¨æ¥å­˜å‚¨å¯è§æ•°æ®äº†ï¼Œè¿™ä¸ªåˆ—è¡¨åªå¹²ä¸€ä»¶äº‹ï¼Œèåˆæ™®é€šé˜Ÿåˆ—å’ŒVIPé˜Ÿåˆ—çš„æ¶ˆæ¯ç”¨äºsetDataæ—¶åˆ·æ–°åˆ°å±å¹•ä¸Šçš„æ•°æ®ã€‚ ğŸš€å®æˆ˜é¡¹ç›®ï¼šgqueuehttps://github.com/GUAIK-ORG/gqueue","categories":[],"tags":[{"name":"å‰ç«¯","slug":"å‰ç«¯","permalink":"https://guaik.github.io/tags/%E5%89%8D%E7%AB%AF/"},{"name":"é˜Ÿåˆ—","slug":"é˜Ÿåˆ—","permalink":"https://guaik.github.io/tags/%E9%98%9F%E5%88%97/"},{"name":"èŠå¤©å®¤","slug":"èŠå¤©å®¤","permalink":"https://guaik.github.io/tags/%E8%81%8A%E5%A4%A9%E5%AE%A4/"},{"name":"ä¼˜åŒ–","slug":"ä¼˜åŒ–","permalink":"https://guaik.github.io/tags/%E4%BC%98%E5%8C%96/"}]},{"title":"åŠ æƒéšæœºç®—æ³•","slug":"åŠ æƒéšæœºç®—æ³•","date":"2020-04-12T14:02:06.000Z","updated":"2020-04-12T14:26:38.217Z","comments":true,"path":"2020/04/12/åŠ æƒéšæœºç®—æ³•/","link":"","permalink":"https://guaik.github.io/2020/04/12/%E5%8A%A0%E6%9D%83%E9%9A%8F%E6%9C%BA%E7%AE%97%E6%B3%95/","excerpt":"","text":"ç™½è¯åŸç†ç”Ÿæ´»ä¸­æœ€å¸¸è§çš„ä¸€ä¸ªä¾‹å­ï¼šç°åœ¨æœ‰4ä¸ªçº¢çƒå’Œ6ä¸ªé»‘çƒï¼ŒæŠŠè¿™10ä¸ªçƒæ”¾å…¥åˆ°ä¸€ä¸ªä¸é€æ˜çš„è¢‹å­ä¸­æ‰“ä¹±ï¼Œé‚£ä¹ˆå»è¢‹å­ä¸­æ‹¿åˆ°çº¢çƒçš„æ¦‚ç‡æ˜¯4/10ï¼Œæ‹¿åˆ°é»‘çƒçš„æ¦‚ç‡æ˜¯6/10ï¼Œä¹Ÿå¯ä»¥è¯´è¢‹å­åˆ†é…ç»™æˆ‘çº¢çƒçš„æ¦‚ç‡æ˜¯4/10ï¼Œåˆ†é…ç»™æˆ‘é»‘çƒçš„æ¦‚ç‡æ˜¯6/10ã€‚ å®é™…åº”ç”¨ ç½‘å…³æœåŠ¡å™¨é€šå¸¸éƒ½ä¼šé€šè¿‡è´Ÿè½½å‡è¡¡å»åˆ†æ‘Šè®¡ç®—å‹åŠ›ï¼Œæœ‰çš„æœåŠ¡å™¨æ€§èƒ½ä¼šå¥½ä¸€äº›ï¼Œæœ‰çš„ä¼šå·®ä¸€äº›ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡æƒé‡é…æ¯”çš„å½¢å¼å°†è¾ƒå¤§çš„è®¡ç®—å‹åŠ›ç»™åˆ°æ€§èƒ½è¾ƒå¥½çš„æœåŠ¡å™¨ã€‚ å½“æŸå°æœåŠ¡å™¨çªç„¶å‡ºç°æ•…éšœæ—¶ï¼Œå¾®æœåŠ¡æ¶æ„å¯ä»¥é€šè¿‡æœåŠ¡æ³¨å†Œå‘ç°å°†æ•…éšœçš„æœåŠ¡å™¨ç§»é™¤ï¼Œå¦‚æœæ˜¯ç½‘å…³æœåŠ¡å™¨çš„è¯æˆ‘ä»¬å¯ä»¥å°†è´Ÿè½½å‡è¡¡çš„æƒé‡ç½®0ã€‚ å®ç°ä»£ç 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950// å®ä¾‹å¯¹è±¡type Object struct &#123; Weight int // æƒé‡ Object interface&#123;&#125; // æœåŠ¡å¯¹è±¡&#125;// è°ƒåº¦å¯¹è±¡type Dispatch struct &#123; Sources []*Object // æ‰€æœ‰æœåŠ¡å¯¹è±¡ SLB []*Object // è´Ÿè½½å‡è¡¡ç”Ÿæˆçš„å¯¹è±¡ TotalWeight int // æ€»æƒé‡&#125;// åˆå§‹åŒ–func (dispatch *Dispatch) Init() (err error) &#123; dispatch.Sources = make([]*LiveObject, 0) dispatch.SLB = make([]*LiveObject, 0) dispatch.TotalWeight = 0 return&#125;// é‡æ–°ç”Ÿæˆè´Ÿè½½å‡è¡¡é˜Ÿåˆ—func (dispatch *Dispatch) reGenSLBArray() &#123; dispatch.SLB = make([]*LiveObject, 0) dispatch.TotalWeight = 0 for _, item := range dispatch.Sources &#123; dispatch.TotalWeight += item.Weight for i := 0; i &lt; item.Weight; i++ &#123; dispatch.SLB = append(dispatch.SLB, item) &#125; &#125; // éšæœºæ’åˆ—é¡ºåº rand.Seed(time.Now().UnixNano()) rand.Shuffle(dispatch.TotalWeight, func(i, j int) &#123; dispatch.SLB[i], dispatch.SLB[j] = dispatch.SLB[j], dispatch.SLB[i] &#125;)&#125;// æ·»åŠ æœåŠ¡å¯¹è±¡func (dispatch *Dispatch) AddObject(object *Object) &#123; dispatch.Sources = append(dispatch.Sources, object) dispatch.reGenSLBArray()&#125;// è·å–å¯¹è±¡func (dispatch *Dispatch) GetObject() (object *Object) &#123; rand.Seed(time.Now().UnixNano()) return dispatch.SLB[rand.Intn(dispatch.TotalWeight)]&#125;","categories":[],"tags":[{"name":"golang","slug":"golang","permalink":"https://guaik.github.io/tags/golang/"},{"name":"è´Ÿè½½å‡è¡¡","slug":"è´Ÿè½½å‡è¡¡","permalink":"https://guaik.github.io/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"}]},{"title":"åŸºäºRedisçš„åˆ†å¸ƒå¼é”","slug":"åŸºäºRedisçš„åˆ†å¸ƒå¼é”","date":"2020-04-12T12:38:39.000Z","updated":"2020-04-12T15:07:03.488Z","comments":true,"path":"2020/04/12/åŸºäºRedisçš„åˆ†å¸ƒå¼é”/","link":"","permalink":"https://guaik.github.io/2020/04/12/%E5%9F%BA%E4%BA%8ERedis%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/","excerpt":"","text":"ä¸ºä»€ä¹ˆè¦ä½¿ç”¨åˆ†å¸ƒå¼é”ä¸¾ä¸ªæ —å­ï¼Œåœ¨è®¾è®¡ç›´æ’­é—´å¼€æ’­æµç¨‹çš„æ—¶å€™ä¼šæ‰§è¡Œå¾ˆå¤šåˆå§‹åŒ–çš„æ“ä½œï¼Œä¹Ÿä¼šåœ¨ç¼“å­˜ä¸­åˆ›å»ºæœ¬æ¬¡ç›´æ’­çš„è®°å½•æ•°æ®ï¼Œä¸ºäº†é¿å…ä¸»æ’­è¯¯æ“ä½œåŒæ—¶æ‰§è¡Œå¼€æ’­æµç¨‹å¤šæ¬¡ï¼Œåœ¨å¼€æ’­æˆåŠŸåä¼šè®¾ç½®å¼€æ’­çŠ¶æ€ï¼Œå¼€æ’­æ—¶åˆ¤æ–­çŠ¶æ€ä¸ºå·²å¼€æ’­åˆ™ä¸å¤„ç†ï¼Œç›´æ’­ç³»ç»Ÿæ˜¯å¤šå®ä¾‹éƒ¨ç½²çš„ï¼Œä¸ºäº†ä¿æŠ¤å¼€æ’­çŠ¶æ€ï¼Œéœ€è¦åšåˆ°åŒä¸€æ—¶é—´åªèƒ½ç”±ä¸€å°æœåŠ¡å™¨å¤„ç†å¼€æ’­æµç¨‹ï¼Œè¿™æ—¶å€™å°±ä¼šç”¨åˆ°åˆ†å¸ƒå¼é”è¿›è¡ŒåŠ é”ä¿æŠ¤ã€‚ çº¿ç¨‹é”ä¸åˆ†å¸ƒå¼é”é”çš„æ„ä¹‰åœ¨äºä¿æŠ¤å…¨å±€å¯è§å¯¹è±¡ã€‚åœ¨å•è¿›ç¨‹ä¸­ä½¿ç”¨å¤šçº¿ç¨‹æ—¶ä¼šé€šè¿‡çº¿ç¨‹é”å»ä¿æŠ¤å½“å‰è¿›ç¨‹ä¸­çš„å…¨å±€å¯¹è±¡ï¼ˆæŸäº›æƒ…å†µå¯ç”¨åŸå­æ“ä½œï¼‰ã€‚åˆ†å¸ƒå¼ç³»ç»Ÿå¯ç†è§£ä¸ºå¤šè¿›ç¨‹ç³»ç»Ÿï¼Œçº¿ç¨‹é”æ— æ³•é”ä½å…¶ä»–è¿›ç¨‹ä¸­çš„æ‰§è¡Œæµç¨‹ï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªå…¨å±€çš„é”æ¥ç®¡æ§æ‰€æœ‰è¿›ç¨‹ä¸­çš„æ‰§è¡Œæµç¨‹ï¼ˆå¦‚æœç›¸åŒåç§°çš„é”å¤„äºä¸Šé”çŠ¶æ€åˆ™ç­‰å¾…ï¼‰ã€‚ Redisä¸SetNXRedisæ˜¯å•è¿›ç¨‹ç³»ç»Ÿï¼Œå®ƒçš„SetNXæ˜¯ä¸ªåŸå­æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸¤ç‚¹æ¥å®ç°åˆ†å¸ƒå¼é”ã€‚å¦‚æœSetNXæ‰§è¡ŒæˆåŠŸåˆ™æ„å‘³ç€æ‹¿åˆ°äº†é”ï¼Œç›¸åæ‰§è¡Œå¤±è´¥åˆ™å¾ªç¯ç­‰å¾…æ‹¿é”æˆ–è¶…æ—¶é€€å‡ºã€‚ è®¾è®¡æ³¨æ„äº‹é¡¹1ã€ä¸ºäº†é¿å…å•æŒæœ‰é”çš„è¿›ç¨‹å¥”æºƒè€Œæ— æ³•é‡Šæ”¾é”ï¼Œæ‰€ä»¥å¿…é¡»èƒ½å¤Ÿä¸ºé”è®¾å®šè¿‡æœŸæ—¶é—´è‡ªåŠ¨é‡Šæ”¾é”èµ„æºã€‚ 2ã€ä½¿ç”¨TTLæ£€æŸ¥é”æ˜¯å¦æˆåŠŸçš„è¢«è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå¦‚æœè¿”å›-1ï¼ˆæœªè¢«è®¾ç½®ï¼‰çš„è¯ï¼Œä½¿ç”¨Expireä¸ºå…¶è®¾å®šè¿‡æœŸæ—¶é—´ã€‚ 3ã€åœ¨é‡Šæ”¾é”çš„æ—¶å€™éœ€è¦ä½¿ç”¨Watchå‘½ä»¤ï¼Œç¡®ä¿ç›‘æµ‹çš„å€¼åœ¨äº‹åŠ¡æ‰§è¡Œæ—¶æ—¶æœªè¢«æ”¹å˜ï¼Œå¦‚æœå…¶ä»–è¿›ç¨‹ä¿®æ”¹äº†é”ï¼Œä¼šè§¦å‘äº‹åŠ¡å¼‚å¸¸ï¼Œç„¶åé‡æ–°æ‰§è¡ŒWatchã€‚ åˆ†äº«ä¸€ä¸ªæˆ‘å†™çš„Rediså°è£…ç±»ï¼Œä»…å®ç°äº†è¿æ¥å’Œé” 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374package daoimport ( \"time\" \"github.com/go-redis/redis/v7\" uuid \"github.com/satori/go.uuid\")type Rds struct &#123; Client *redis.Client AcquireTimeout int32 LockTimeout int32&#125;func NewRds(host, passwd string, db int) (rds *Rds, err error) &#123; rdsOpt := &amp;redis.Options&#123; Addr: host, Password: passwd, DB: db, &#125; client := redis.NewClient(rdsOpt) _, err = client.Ping().Result() if err != nil &#123; return &#125; rds = &amp;Rds&#123;Client: client, AcquireTimeout: 10, LockTimeout: 10&#125; return&#125;func (r *Rds) AcquireLockWithTimeout(key string) (identifier string, b bool) &#123; identifier = uuid.NewV4().String() lockname := \"lock:\" + key end := time.Now().Add(time.Second * time.Duration(r.AcquireTimeout)) for time.Now().Before(end) &#123; if r.Client.SetNX(lockname, identifier, time.Second*time.Duration(r.LockTimeout)).Val() &#123; // å¦‚æœkeyä¸å­˜åœ¨ï¼Œå¹¶æˆåŠŸè®¾ç½®äº†key b = true return &#125; else if r.Client.TTL(lockname).Val() == -1 &#123; // å¦‚æœkeyå­˜åœ¨ï¼Œä½†æ˜¯æ²¡æœ‰å‰©ä½™æ—¶é—´ r.Client.Expire(lockname, time.Second*time.Duration(r.LockTimeout)) &#125; time.Sleep(time.Microsecond) &#125; return&#125;func (r *Rds) ReleaseLock(key, identifier string) (b bool) &#123; lockname := \"lock:\" + key txf := func(tx *redis.Tx) error &#123; v, err := tx.Get(lockname).Result() if err != nil &#123; return err &#125; _, err = tx.Pipelined(func(pipe redis.Pipeliner) error &#123; if v == identifier &#123; pipe.Del(lockname) b = true &#125; return nil &#125;) return err &#125; for &#123; err := r.Client.Watch(txf, lockname) if err == nil &#123; break &#125; else if err == redis.TxFailedErr &#123; glog.Error(err) &#125; &#125; return&#125;","categories":[],"tags":[{"name":"golang","slug":"golang","permalink":"https://guaik.github.io/tags/golang/"},{"name":"redis","slug":"redis","permalink":"https://guaik.github.io/tags/redis/"},{"name":"åˆ†å¸ƒå¼é”","slug":"åˆ†å¸ƒå¼é”","permalink":"https://guaik.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"}]}],"categories":[],"tags":[{"name":"å‰ç«¯","slug":"å‰ç«¯","permalink":"https://guaik.github.io/tags/%E5%89%8D%E7%AB%AF/"},{"name":"é˜Ÿåˆ—","slug":"é˜Ÿåˆ—","permalink":"https://guaik.github.io/tags/%E9%98%9F%E5%88%97/"},{"name":"èŠå¤©å®¤","slug":"èŠå¤©å®¤","permalink":"https://guaik.github.io/tags/%E8%81%8A%E5%A4%A9%E5%AE%A4/"},{"name":"ä¼˜åŒ–","slug":"ä¼˜åŒ–","permalink":"https://guaik.github.io/tags/%E4%BC%98%E5%8C%96/"},{"name":"golang","slug":"golang","permalink":"https://guaik.github.io/tags/golang/"},{"name":"è´Ÿè½½å‡è¡¡","slug":"è´Ÿè½½å‡è¡¡","permalink":"https://guaik.github.io/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"},{"name":"redis","slug":"redis","permalink":"https://guaik.github.io/tags/redis/"},{"name":"åˆ†å¸ƒå¼é”","slug":"åˆ†å¸ƒå¼é”","permalink":"https://guaik.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"}]}