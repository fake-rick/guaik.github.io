<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>æ€ªå®¢çš„Blog</title>
  
  <subtitle>åˆ†äº«ä¸€äº›é»‘ç§‘æŠ€</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://guaik.github.io/"/>
  <updated>2020-04-15T04:47:49.091Z</updated>
  <id>https://guaik.github.io/</id>
  
  <author>
    <name>guaik</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>é€’å½’ç®—æ³•ï¼Œluaçš„tableä¸jsonäº’è½¬</title>
    <link href="https://guaik.github.io/2020/04/15/%E9%80%92%E5%BD%92%E7%AE%97%E6%B3%95%EF%BC%8Clua%E7%9A%84table%E4%B8%8Ejson%E4%BA%92%E8%BD%AC/"/>
    <id>https://guaik.github.io/2020/04/15/%E9%80%92%E5%BD%92%E7%AE%97%E6%B3%95%EF%BC%8Clua%E7%9A%84table%E4%B8%8Ejson%E4%BA%92%E8%BD%AC/</id>
    <published>2020-04-15T04:10:00.000Z</published>
    <updated>2020-04-15T04:47:49.091Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ ‡é¢˜å‡ ä¹æ˜¯å…³é”®è¯ç»„æˆï¼Œé‚£ä¹ˆè¿™ç¯‡æ–‡ç« ä¼šè®²äº›ä»€ä¹ˆï¼Ÿ"><a href="#æ ‡é¢˜å‡ ä¹æ˜¯å…³é”®è¯ç»„æˆï¼Œé‚£ä¹ˆè¿™ç¯‡æ–‡ç« ä¼šè®²äº›ä»€ä¹ˆï¼Ÿ" class="headerlink" title="æ ‡é¢˜å‡ ä¹æ˜¯å…³é”®è¯ç»„æˆï¼Œé‚£ä¹ˆè¿™ç¯‡æ–‡ç« ä¼šè®²äº›ä»€ä¹ˆï¼Ÿ"></a>æ ‡é¢˜å‡ ä¹æ˜¯å…³é”®è¯ç»„æˆï¼Œé‚£ä¹ˆè¿™ç¯‡æ–‡ç« ä¼šè®²äº›ä»€ä¹ˆï¼Ÿ</h2><ul><li>é€’å½’ç®—æ³•çš„ä½¿ç”¨</li><li>golangè°ƒç”¨luaçš„æ–¹æ³•</li><li>luaä¸­tableä¸jsonçš„ç›¸äº’è½¬æ¢</li></ul><h2 id="é€’å½’ç®—æ³•"><a href="#é€’å½’ç®—æ³•" class="headerlink" title="é€’å½’ç®—æ³•"></a>é€’å½’ç®—æ³•</h2><h3 id="ç‰¹æ€§"><a href="#ç‰¹æ€§" class="headerlink" title="ç‰¹æ€§"></a>ç‰¹æ€§</h3><p>å¤„ç†å±‚çº§å…³ç³»çš„ç»“æ„ï¼Œéå†æ•°æ®éå®ƒè«å±</p><h3 id="å¦‚ä½•è®¾è®¡é€’å½’"><a href="#å¦‚ä½•è®¾è®¡é€’å½’" class="headerlink" title="å¦‚ä½•è®¾è®¡é€’å½’"></a>å¦‚ä½•è®¾è®¡é€’å½’</h3><ul><li><p>å±‚çº§åˆ†ç±»ï¼Œç»Ÿä¸€å‡½æ•°å‚æ•°ä¸è¿”å›å€¼</p></li><li><p>ä½•æ—¶å¼€å§‹è¿”å›</p></li></ul><h3 id="åº”ç”¨"><a href="#åº”ç”¨" class="headerlink" title="åº”ç”¨"></a>åº”ç”¨</h3><p>å°ç™½èƒ½å¬æ‡‚çš„ï¼šä»€ä¹ˆæ˜¯å±‚çº§å…³ç³»çš„ç»“æ„å‘¢ï¼Ÿåœ¨windowsç³»ç»Ÿä¸­æœ‰ä¸ªâ€œæˆ‘çš„ç”µè„‘â€ï¼Œâ€œæˆ‘çš„ç”µè„‘â€ä¸­è¿˜æœ‰C,D,E,Fç›˜ï¼ŒCç›˜ä¸­è¿˜æœ‰windowsç›®å½•å­˜æ”¾ç³»ç»Ÿæ–‡ä»¶ï¼ŒDç›˜ä¸­è¿˜æœ‰æˆ‘çè—å¤šå¹´çš„ã€æ—¥æœ¬***ç©ºå°å§ã€‘ã€‚æ‰€ä»¥æœ€ç®€å•çš„ç†è§£å°±æ˜¯ä¸€å±‚å¥—ä¸€å±‚çš„å…³ç³»ã€‚</p><p>ä¸­ç™½èƒ½å¬æ‡‚çš„ï¼šäºŒå‰æ ‘éå†ï¼Œçˆ¶å­èŠ‚ç‚¹å…³ç³»ã€‚jsonä¸­ä¸€å±‚å±‚çš„èŠ±æ‹¬å·{}ã€‚è¿™äº›éƒ½æ˜¯æ˜æ˜¾çš„å±‚çº§å…³ç³»ã€‚</p><p>æ‰€ä»¥æœ¬æ–‡ä¸­å¤„ç†tableä¸jsonçš„è½¬æ¢å°±ä½¿ç”¨é€’å½’ç®—æ³•ã€‚</p><h2 id="golangå¦‚ä½•è°ƒç”¨luaçš„æ–¹æ³•"><a href="#golangå¦‚ä½•è°ƒç”¨luaçš„æ–¹æ³•" class="headerlink" title="golangå¦‚ä½•è°ƒç”¨luaçš„æ–¹æ³•"></a>golangå¦‚ä½•è°ƒç”¨luaçš„æ–¹æ³•</h2><h3 id="luaæ˜¯ä»€ä¹ˆ"><a href="#luaæ˜¯ä»€ä¹ˆ" class="headerlink" title="luaæ˜¯ä»€ä¹ˆ"></a>luaæ˜¯ä»€ä¹ˆ</h3><p>é¦–å…ˆå®ƒæ˜¯ä¸€é—¨è„šæœ¬è¯­è¨€ï¼Œä½†æ˜¯å®ƒç‰¹åˆ«é€‚åˆåµŒå…¥å…¶ä»–çš„è¯­è¨€ä¸­ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆè¦åµŒå…¥å…¶ä»–è¯­è¨€å‘¢ï¼Ÿè‡ªå·±éƒ½æ˜¯ä¸€ä¸ªè¯­è¨€äº†åœ¨åµŒå…¥ä¸ªluaä¸å¤šä½™å—ï¼Ÿ</p><p>æˆ‘å°±æ‹¿C++ä¸¾ä¸ªæ —å­ï¼ŒC++çš„ç¨‹åºæ¯æ¬¡æ›´æ–°ä»£ç éƒ½æ˜¯éœ€è¦é‡æ–°ç¼–è¯‘é“¾æ¥çš„ï¼Œå“ªæ€•æ”¹åŠ¨ä¸€ç‚¹é€»è¾‘å°±è¦é‡æ–°ç¼–è¯‘æ‰è¡Œã€‚æŸäº›æƒ…å†µä¸‹ç¨‹åºç»å¸¸ä¼šä¿®æ”¹ä¸€äº›ä¸šåŠ¡é€»è¾‘ï¼Œæ¸¸æˆä¸­çš„æ™ºèƒ½çŠ¶æ€æœºï¼Œåœ¨è°ƒè¯•çš„æ—¶å€™æ¯æ¬¡ä¿®æ”¹éƒ½éœ€è¦é‡æ–°ç¼–è¯‘é“¾æ¥å°±å¤ªéº»çƒ¦äº†ï¼Œå¦‚æœæŠŠçŠ¶æ€æœºå†™ä¸ªæ¥å£ç»™luaå»è°ƒç”¨ï¼Œä¿®æ”¹è„šæœ¬å°±å¯ä»¥è°ƒæ•´çŠ¶æ€æœºçš„é€»è¾‘ï¼Œè¿™å¤ªçˆ½äº†ã€‚</p><ul><li>å®‰è£…luaçš„ä¾èµ–åŒ…</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> get github.com/yuin/gopher-lua</span><br></pre></td></tr></table></figure><h3 id="luaçš„è¿è¡Œæ—¶ç¯å¢ƒ"><a href="#luaçš„è¿è¡Œæ—¶ç¯å¢ƒ" class="headerlink" title="luaçš„è¿è¡Œæ—¶ç¯å¢ƒ"></a>luaçš„è¿è¡Œæ—¶ç¯å¢ƒ</h3><p>luaçš„è¿è¡ŒçŠ¶æ€ï¼ˆStateï¼‰å­˜æ”¾ç€è¿è¡Œæ—¶çš„ä¸€äº›å…³é”®æ•°æ®ï¼šè¿è¡Œå †æ ˆï¼Œä¸Šä¸‹æ–‡æ•°æ®ç­‰ï¼ˆè®°ä¸æ¸…äº†è®²å¤šäº†ä½ ä¹Ÿè®°ä¸ä½ï¼‰ï¼Œæ€»ä¹‹ä¸åŒçš„çŠ¶æ€æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œä¸åŒçš„çŠ¶æ€é—´æ•°æ®æ˜¯ä¸å¯è§çš„ï¼Œæ‰€ä»¥å¤šçº¿ç¨‹å®‰å…¨ã€‚</p><ul><li>åˆ›å»ºluaçŠ¶æ€</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env := lua.NewState()</span><br></pre></td></tr></table></figure><h3 id="golangä¸luaçš„äº¤äº’"><a href="#golangä¸luaçš„äº¤äº’" class="headerlink" title="golangä¸luaçš„äº¤äº’"></a>golangä¸luaçš„äº¤äº’</h3><p>luaä½œä¸ºä¸€é—¨åµŒå…¥å¼çš„è¯­è¨€ï¼Œæœ‰ä¸ªå¾ˆé‡è¦çš„ç‰¹ç‚¹å°±æ˜¯èƒ½å¤Ÿåœ¨luaä¸­èƒ½å¤Ÿè°ƒç”¨è¢«å¯„ç”Ÿè¯­è¨€çš„å‡½æ•°ï¼ˆå¯„ç”Ÿå…½çœ‹è¿‡å§ï¼Ÿï¼‰ï¼Œè¿™æ ·å°±å®Œæˆäº†è¢«å¯„å®¿çš„è¯­è¨€å¼€æ”¾æ¥å£ï¼Œç„¶åé€šè¿‡luaç¼–å†™è„šæœ¬å°±èƒ½å¤Ÿæ–¹ä¾¿çš„ä¿®æ”¹é€»è¾‘äº†ã€‚</p><ul><li>åœ¨luaä¸­æ³¨å†Œæ–°çš„å‡½æ•°</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// è½¬æ¢çš„é€»è¾‘æ˜¯ç”±golangç¼–å†™çš„æä¾›ç»™luaè°ƒç”¨çš„æ¥å£ä»£ç </span></span><br><span class="line"><span class="comment">/// luaæœ¬èº«ä¸æ”¯æŒtableä¸jsonäº’è½¬</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// tableè½¬jsonå­—ç¬¦ä¸²</span></span><br><span class="line">env.SetGlobal(<span class="string">"jsonMarshal"</span>, env.NewFunction(luaJson.JsonMarshal))</span><br><span class="line"><span class="comment">// jsonå­—ç¬¦ä¸²è½¬table</span></span><br><span class="line">env.SetGlobal(<span class="string">"jsonUnMarshal"</span>, env.NewFunction(luaJson.JsonUnMarshal))</span><br></pre></td></tr></table></figure><ul><li>ç›¸å…³æ¥å£ä»£ç </li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"encoding/json"</span></span><br><span class="line">    <span class="string">"github.com/golang/glog"</span></span><br><span class="line">    lua <span class="string">"github.com/yuin/gopher-lua"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ£€æŸ¥Tableæ˜¯å¦ä¸ºList</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">checkList</span><span class="params">(value lua.LValue)</span> <span class="params">(b <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> value.Type().String() == <span class="string">"table"</span> &#123;</span><br><span class="line">        b = <span class="literal">true</span></span><br><span class="line">        value.(*lua.LTable).ForEach(<span class="function"><span class="keyword">func</span><span class="params">(k, v lua.LValue)</span></span> &#123;</span><br><span class="line">            <span class="keyword">if</span> k.Type().String() != <span class="string">"number"</span> &#123;</span><br><span class="line">                b = <span class="literal">false</span></span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">marshal</span><span class="params">(data lua.LValue)</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line">    <span class="keyword">switch</span> data.Type() &#123;</span><br><span class="line">    <span class="keyword">case</span> lua.LTTable:</span><br><span class="line">        <span class="keyword">if</span> checkList(data) &#123;</span><br><span class="line">            jdata := <span class="built_in">make</span>([]<span class="keyword">interface</span>&#123;&#125;, <span class="number">0</span>)</span><br><span class="line">            data.(*lua.LTable).ForEach(<span class="function"><span class="keyword">func</span><span class="params">(key, value lua.LValue)</span></span> &#123;</span><br><span class="line">                jdata = <span class="built_in">append</span>(jdata, marshal(value))</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">return</span> jdata</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            jdata := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;&#125;</span><br><span class="line">            data.(*lua.LTable).ForEach(<span class="function"><span class="keyword">func</span><span class="params">(key, value lua.LValue)</span></span> &#123;</span><br><span class="line">                jdata[key.String()] = marshal(value)</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">return</span> jdata</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">case</span> lua.LTNumber:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">float64</span>(data.(lua.LNumber))</span><br><span class="line">    <span class="keyword">case</span> lua.LTString:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">string</span>(data.(lua.LString))</span><br><span class="line">    <span class="keyword">case</span> lua.LTBool:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">bool</span>(data.(lua.LBool))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">JsonMarshal</span><span class="params">(L *lua.LState)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    data := L.ToTable(<span class="number">1</span>)</span><br><span class="line">    str, err := json.Marshal(marshal(data))</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        glog.Error(err)</span><br><span class="line">    &#125;</span><br><span class="line">    L.Push(lua.LString(str))</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">unmarshal</span><span class="params">(L *lua.LState, data <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">lua</span>.<span class="title">LValue</span></span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> data.(<span class="keyword">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;:</span><br><span class="line">        tb := L.NewTable()</span><br><span class="line">        <span class="keyword">for</span> k, v := <span class="keyword">range</span> data.(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;) &#123;</span><br><span class="line">            tb.RawSet(lua.LString(k), unmarshal(L, v))</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> tb</span><br><span class="line">    <span class="keyword">case</span> []<span class="keyword">interface</span>&#123;&#125;:</span><br><span class="line">        tb := L.NewTable()</span><br><span class="line">        <span class="keyword">for</span> i, v := <span class="keyword">range</span> data.([]<span class="keyword">interface</span>&#123;&#125;) &#123;</span><br><span class="line">            tb.Insert(i+<span class="number">1</span>, unmarshal(L, v))</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> tb</span><br><span class="line">    <span class="keyword">case</span> <span class="keyword">float64</span>:</span><br><span class="line">        <span class="keyword">return</span> lua.LNumber(data.(<span class="keyword">float64</span>))</span><br><span class="line">    <span class="keyword">case</span> <span class="keyword">string</span>:</span><br><span class="line">        <span class="keyword">return</span> lua.LString(data.(<span class="keyword">string</span>))</span><br><span class="line">    <span class="keyword">case</span> <span class="keyword">bool</span>:</span><br><span class="line">        <span class="keyword">return</span> lua.LBool(data.(<span class="keyword">bool</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> lua.LNil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">JsonUnMarshal</span><span class="params">(L *lua.LState)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    str := L.ToString(<span class="number">1</span>)</span><br><span class="line">    jdata := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">interface</span>&#123;&#125;&#123;&#125;</span><br><span class="line">    err := json.Unmarshal([]<span class="keyword">byte</span>(str), &amp;jdata)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        glog.Error(err)</span><br><span class="line">    &#125;</span><br><span class="line">    L.Push(unmarshal(L, jdata))</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åœ¨luaä¸­è°ƒç”¨golangæä¾›çš„æ¥å£"><a href="#åœ¨luaä¸­è°ƒç”¨golangæä¾›çš„æ¥å£" class="headerlink" title="åœ¨luaä¸­è°ƒç”¨golangæä¾›çš„æ¥å£"></a>åœ¨luaä¸­è°ƒç”¨golangæä¾›çš„æ¥å£</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processor</span><span class="params">()</span></span></span><br><span class="line">    data = &#123;&#125;</span><br><span class="line">    data[<span class="string">"hello"</span>]=<span class="string">"world"</span></span><br><span class="line">    data[<span class="string">"a"</span>] = &#123;&#125;</span><br><span class="line">    data[<span class="string">"a"</span>][<span class="string">"b"</span>] = <span class="string">"b"</span></span><br><span class="line">    data[<span class="string">"a"</span>][<span class="string">"c"</span>] = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>&#125;</span><br><span class="line">    res = jsonMarshal(data)</span><br><span class="line">    res = jsonUnMarshal(res)</span><br><span class="line">    <span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(res[<span class="string">"a"</span>][<span class="string">"c"</span>]) <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">print</span>(k,v)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;æ ‡é¢˜å‡ ä¹æ˜¯å…³é”®è¯ç»„æˆï¼Œé‚£ä¹ˆè¿™ç¯‡æ–‡ç« ä¼šè®²äº›ä»€ä¹ˆï¼Ÿ&quot;&gt;&lt;a href=&quot;#æ ‡é¢˜å‡ ä¹æ˜¯å…³é”®è¯ç»„æˆï¼Œé‚£ä¹ˆè¿™ç¯‡æ–‡ç« ä¼šè®²äº›ä»€ä¹ˆï¼Ÿ&quot; class=&quot;headerlink&quot; title=&quot;æ ‡é¢˜å‡ ä¹æ˜¯å…³é”®è¯ç»„æˆï¼Œé‚£ä¹ˆè¿™ç¯‡æ–‡ç« ä¼šè®²äº›ä»€ä¹ˆï¼Ÿ&quot;&gt;&lt;/a&gt;æ ‡é¢˜å‡ ä¹æ˜¯å…³é”®è¯ç»„æˆï¼Œé‚£ä¹ˆè¿™ç¯‡æ–‡ç« 
      
    
    </summary>
    
    
    
      <category term="é€’å½’" scheme="https://guaik.github.io/tags/%E9%80%92%E5%BD%92/"/>
    
      <category term="lua" scheme="https://guaik.github.io/tags/lua/"/>
    
      <category term="table" scheme="https://guaik.github.io/tags/table/"/>
    
      <category term="json" scheme="https://guaik.github.io/tags/json/"/>
    
  </entry>
  
  <entry>
    <title>æ¶ˆæ¯é˜Ÿåˆ—åœ¨å‰ç«¯çš„åº”ç”¨</title>
    <link href="https://guaik.github.io/2020/04/13/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%9C%A8%E5%89%8D%E7%AB%AF%E7%9A%84%E5%BA%94%E7%94%A8/"/>
    <id>https://guaik.github.io/2020/04/13/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%9C%A8%E5%89%8D%E7%AB%AF%E7%9A%84%E5%BA%94%E7%94%A8/</id>
    <published>2020-04-12T16:21:12.000Z</published>
    <updated>2020-04-12T17:37:37.504Z</updated>
    
    <content type="html"><![CDATA[<h2 id="é˜Ÿåˆ—ä¸å †æ ˆçš„åŒºåˆ«"><a href="#é˜Ÿåˆ—ä¸å †æ ˆçš„åŒºåˆ«" class="headerlink" title="é˜Ÿåˆ—ä¸å †æ ˆçš„åŒºåˆ«"></a>é˜Ÿåˆ—ä¸å †æ ˆçš„åŒºåˆ«</h2><p>é˜Ÿåˆ—ç”±ä¸€ä¸ªå…¥å£å’Œä¸€ä¸ªå‡ºå£ç»„æˆï¼Œå…ˆè¿›å…ˆå‡ºã€‚å †æ ˆåªæœ‰ä¸€ä¸ªå£ï¼Œåè¿›å…ˆå‡ºã€‚</p><h2 id="ç”Ÿäº§æ¶ˆè´¹è€…æ¨¡å‹ä¸é˜Ÿåˆ—"><a href="#ç”Ÿäº§æ¶ˆè´¹è€…æ¨¡å‹ä¸é˜Ÿåˆ—" class="headerlink" title="ç”Ÿäº§æ¶ˆè´¹è€…æ¨¡å‹ä¸é˜Ÿåˆ—"></a>ç”Ÿäº§æ¶ˆè´¹è€…æ¨¡å‹ä¸é˜Ÿåˆ—</h2><p>é˜Ÿåˆ—æ˜¯å¯ä»¥ç”¨æ¥åšç¼“å†²åŒºä½¿ç”¨çš„ï¼Œå½“çŸ­æ—¶é—´å†…å‡ºç°å¤§é‡æ•°æ®çš„æ—¶å€™ä¼šé€ æˆè½¯ä»¶æˆ–æ•´ä¸ªç³»ç»Ÿçš„ä¸ç¨³å®šï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±å¯ä»¥æŠŠæ•°æ®å…ˆä¸¢åˆ°é˜Ÿåˆ—ä¸­ç¼“å­˜èµ·æ¥ï¼Œç„¶åä»¥åˆé€‚çš„é€Ÿåº¦è·å–å¹¶å¤„ç†æ•°æ®ä¿éšœç³»ç»Ÿçš„ç¨³å®šã€‚è¿™å°±æ˜¯ç”Ÿäº§æ¶ˆè´¹æ¨¡å‹ï¼Œç”Ÿäº§è€…è´Ÿè´£ç”Ÿäº§æ•°æ®è€Œæ¶ˆè´¹è€…è´Ÿè´£å¤„ç†æ•°æ®ã€‚</p><h2 id="æ¶ˆæ¯é˜Ÿåˆ—åœ¨åç«¯å¼€å‘çš„åº”ç”¨"><a href="#æ¶ˆæ¯é˜Ÿåˆ—åœ¨åç«¯å¼€å‘çš„åº”ç”¨" class="headerlink" title="æ¶ˆæ¯é˜Ÿåˆ—åœ¨åç«¯å¼€å‘çš„åº”ç”¨"></a>æ¶ˆæ¯é˜Ÿåˆ—åœ¨åç«¯å¼€å‘çš„åº”ç”¨</h2><ul><li><p>ç”µå•†å¹³å°æœ‰ä¸€é¡¹ä¸šåŠ¡ï¼šç§’æ€æ´»åŠ¨ã€‚åœ¨æçŸ­çš„æ—¶é—´å†…æœåŠ¡å™¨å°†ä¼šæ”¶åˆ°å¤§é‡å•†å“çš„è´­ä¹°è¯·æ±‚ï¼Œå¦‚ä½•é™ä½ä¸šåŠ¡æœåŠ¡å™¨å—åˆ°çš„å†²å‡»å‘¢ï¼Ÿæˆ‘ä»¬ä¼šä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œå‰Šå³°å¤„ç†ã€‚å¸¸ç”¨çš„åç«¯æ¶ˆæ¯é˜Ÿåˆ—æœ‰ï¼šKafkaã€RabbitMQã€ActiveMQã€ZeroMQã€‚</p></li><li><p>æ¶ˆæ¯é˜Ÿåˆ—é€šå¸¸éƒ½æ”¯æŒå¤šä¸ªè®¢é˜…è€…ï¼Œåˆ©ç”¨è¿™ä¸ªç‰¹æ€§å¯ä»¥å®ç°ä¸€äº›æœåŠ¡çš„è´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚</p></li></ul><h2 id="ğŸ“æ­£é¢˜ï¼šé˜Ÿåˆ—åœ¨å‰ç«¯çš„åº”ç”¨"><a href="#ğŸ“æ­£é¢˜ï¼šé˜Ÿåˆ—åœ¨å‰ç«¯çš„åº”ç”¨" class="headerlink" title="ğŸ“æ­£é¢˜ï¼šé˜Ÿåˆ—åœ¨å‰ç«¯çš„åº”ç”¨"></a>ğŸ“æ­£é¢˜ï¼šé˜Ÿåˆ—åœ¨å‰ç«¯çš„åº”ç”¨</h2><h3 id="é™é€Ÿï¼Œè®©ç•Œé¢æ›´æµç•…ä¸€äº›"><a href="#é™é€Ÿï¼Œè®©ç•Œé¢æ›´æµç•…ä¸€äº›" class="headerlink" title="é™é€Ÿï¼Œè®©ç•Œé¢æ›´æµç•…ä¸€äº›"></a>é™é€Ÿï¼Œè®©ç•Œé¢æ›´æµç•…ä¸€äº›</h3><p>åœ¨èŠå¤©å®¤åº”ç”¨ä¸­å°‘åˆ™0äººå¤šåˆ™ä¸Šä¸‡äººï¼Œåœ¨æ”¶åˆ°å¤§é‡å³æ—¶é€šè®¯æ¶ˆæ¯æ—¶å¦‚æœä¸åŠ å¤„ç†å…¨éƒ¨æ‹¿å»åœ¨ç•Œé¢åšæ¸²æŸ“é‚£ä¹ˆè½»åˆ™ç•Œé¢å¡é¡¿é‡åˆ™APPå¡æ­»ã€‚å¾®ä¿¡å°ç¨‹åºç»™å‡ºçš„è°ƒç”¨setDataçš„æœ€ä½³æ—¶é—´é—´éš”ä¸º20msï¼Œä¹Ÿå°±æ˜¯å¦‚æœæŠŠæ•°æ®åˆ·æ–°çš„é¢‘ç‡æ§åˆ¶åœ¨20msåˆ·æ–°ä¸€æ¬¡æ˜¯æ›´åˆç†çš„ã€‚æ‰€ä»¥æ¶ˆè´¹è€…åº”è¯¥æ¯éš”20msè·å–å¹¶å¤„ç†ä¸€æ¡æ•°æ®ä¿éšœç•Œé¢çš„ä¸å¡ã€‚</p><h3 id="å‡å°‘æ²¡å¿…è¦çš„å†…å­˜æµªè´¹"><a href="#å‡å°‘æ²¡å¿…è¦çš„å†…å­˜æµªè´¹" class="headerlink" title="å‡å°‘æ²¡å¿…è¦çš„å†…å­˜æµªè´¹"></a>å‡å°‘æ²¡å¿…è¦çš„å†…å­˜æµªè´¹</h3><p>è¿™æ ·é™ä½äº†æ¶ˆè´¹çš„é€Ÿåº¦ï¼Œä¼šå¯¼è‡´é˜Ÿåˆ—ä¸­çš„æ•°æ®ç§¯å‹ä¸¥é‡ï¼Œå¤§é‡æ¶ˆè€—å†…å­˜èµ„æºï¼Œä¸€æ¡æ¶ˆæ¯åœ¨å‡ åˆ†é’Ÿåè¢«çœ‹åˆ°ä¹Ÿæ˜¯å¯èƒ½çš„ï¼Œé‚£å¦‚ä½•å¤„ç†å‘¢ï¼Ÿå‡è®¾1ç§’é’Ÿæ”¶åˆ°äº†1000æ¡èŠå¤©æ¶ˆæ¯ï¼Œé‚£ä¹ˆè¿™äº›æ¶ˆæ¯éœ€è¦å…¨éƒ¨æ˜¾ç¤ºå—ï¼Ÿè‡³å°‘æˆ‘çš„çœ¼ç›æ˜¯æ¥ä¸åŠçœ‹å®Œçš„ï¼Œæ‰€ä»¥å¯ä»¥è®¾å®šé˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦ï¼Œè¶…å‡ºçš„æ¶ˆæ¯å…¨éƒ¨ä¸¢å¼ƒï¼ˆé•¿åº¦æ ¹æ®å®é™…åœºæ™¯è®¾å®šï¼‰ã€‚</p><h3 id="ä¿éšœé‡è¦çš„æ¶ˆæ¯å¿«é€Ÿæ˜¾ç¤ºå¹¶ä¸”å¿…é¡»æ˜¾ç¤º"><a href="#ä¿éšœé‡è¦çš„æ¶ˆæ¯å¿«é€Ÿæ˜¾ç¤ºå¹¶ä¸”å¿…é¡»æ˜¾ç¤º" class="headerlink" title="ä¿éšœé‡è¦çš„æ¶ˆæ¯å¿«é€Ÿæ˜¾ç¤ºå¹¶ä¸”å¿…é¡»æ˜¾ç¤º"></a>ä¿éšœé‡è¦çš„æ¶ˆæ¯å¿«é€Ÿæ˜¾ç¤ºå¹¶ä¸”å¿…é¡»æ˜¾ç¤º</h3><p>æœ‰ä¸ªç”¨æˆ·åœ¨ç›´æ’­é—´åˆ·äº†ä¸ªç«ç®­ï¼Œå—¯ï¼Œç«ç®­è¢«å¤–æ˜ŸäººåŠ«èµ°ä¸è§äº†ï¼Œä¸–ç•Œæœªè§£ä¹‹è°œå‡ºç°ã€‚æˆ–è€…ç”±äºæ•°æ®çš„ç§¯å‹ç«ç®­1åˆ†é’Ÿåç»ˆäºå‡ºç°äº†ï¼Œä¸»æ’­éƒ½ä¸‹æ’­äº†ã€‚</p><p>ä¸ºäº†é¿å…ä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦VIPé˜Ÿåˆ—ï¼Œå¦‚æœè¯´æ™®é€šèŠå¤©æ¶ˆæ¯æ”¾å…¥æ™®é€šé˜Ÿåˆ—ï¼Œé‚£ä¹ˆç°é‡‘ç¤¼ç‰©çš„å°±è¦æ”¾å…¥VIPé˜Ÿåˆ—æ’é˜Ÿäº†ï¼Œå¹¶ä¸”ä½¿å‘½å¿…è¾¾ï¼Œæœ‰ä¸€æ¡æ˜¾ç¤ºä¸€æ¡ã€‚è¿™ä¸ªå®ç°ä¹Ÿå¾ˆå®¹æ˜“ï¼ŒVIPé˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦ä¸ºâˆå¤§ï¼Œä¸åˆ¤æ–­é•¿åº¦å°±è¡Œäº†ï¼Œè™½ç„¶ä¹Ÿè¾¾ä¸åˆ°1ç§’1000ä¸ªç«ç®­çš„é‡ï¼Œä½†é±¼ä¸¸å°±è¯´ä¸å®šäº†ã€‚ç”±äºVIPé˜Ÿåˆ—æ˜¯ç‹¬ç«‹äºæ™®é€šé˜Ÿåˆ—çš„ï¼Œæ‰€ä»¥æ¶ˆæ¯ä¸ä¼šè¢«æ’åœ¨æ™®é€šé˜Ÿåˆ—çš„æœ«å°¾ï¼Œå®ç°äº†æ’é˜Ÿçš„åŠŸèƒ½ï¼Œé€šå¸¸è¿™ä¸ªé˜Ÿåˆ—çš„é‡ä¸ä¼šç‰¹åˆ«å¤§æ‰€ä»¥èƒ½å¤Ÿå¿«é€Ÿæ˜¾ç¤ºå‡ºæ¥ã€‚</p><h3 id="æ•°æ®çš„èåˆï¼Œå±å¹•èƒ½æ˜¾ç¤ºNä¸ªåˆ—è¡¨é¡¹å°±åˆ·æ–°Næ¡æ•°æ®"><a href="#æ•°æ®çš„èåˆï¼Œå±å¹•èƒ½æ˜¾ç¤ºNä¸ªåˆ—è¡¨é¡¹å°±åˆ·æ–°Næ¡æ•°æ®" class="headerlink" title="æ•°æ®çš„èåˆï¼Œå±å¹•èƒ½æ˜¾ç¤ºNä¸ªåˆ—è¡¨é¡¹å°±åˆ·æ–°Næ¡æ•°æ®"></a>æ•°æ®çš„èåˆï¼Œå±å¹•èƒ½æ˜¾ç¤ºNä¸ªåˆ—è¡¨é¡¹å°±åˆ·æ–°Næ¡æ•°æ®</h3><p>å¦‚æœä¸€ä¸ªå±å¹•åªèƒ½æ˜¾ç¤º10ä¸ªåˆ—è¡¨é¡¹ï¼Œä½ æ¯æ¬¡æœ‰å¿…è¦åˆ·æ–°10000æ¡æ•°æ®å—ï¼Ÿè¿˜ä¸å¤Ÿå¡å—ï¼Ÿæ‰€ä»¥å½“å±å¹•åªèƒ½æ˜¾ç¤º10ä¸ªåˆ—è¡¨é¡¹çš„æ—¶å€™æ¯æ¬¡åªåˆ·æ–°æœ€æ–°çš„100æ¡æ•°æ®ï¼Œæ›´å¤šçš„è¯·çœ‹èŠå¤©è®°å½•ã€‚è¿™æ ·å°±åˆå¤šäº†ä¸€ä¸ªåˆ—è¡¨ç”¨æ¥å­˜å‚¨å¯è§æ•°æ®äº†ï¼Œè¿™ä¸ªåˆ—è¡¨åªå¹²ä¸€ä»¶äº‹ï¼Œèåˆæ™®é€šé˜Ÿåˆ—å’ŒVIPé˜Ÿåˆ—çš„æ¶ˆæ¯ç”¨äºsetDataæ—¶åˆ·æ–°åˆ°å±å¹•ä¸Šçš„æ•°æ®ã€‚</p><h2 id="ğŸš€å®æˆ˜é¡¹ç›®ï¼šgqueue"><a href="#ğŸš€å®æˆ˜é¡¹ç›®ï¼šgqueue" class="headerlink" title="ğŸš€å®æˆ˜é¡¹ç›®ï¼šgqueue"></a>ğŸš€å®æˆ˜é¡¹ç›®ï¼šgqueue</h2><p><a href="https://github.com/GUAIK-ORG/gqueue" target="_blank" rel="noopener">https://github.com/GUAIK-ORG/gqueue</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;é˜Ÿåˆ—ä¸å †æ ˆçš„åŒºåˆ«&quot;&gt;&lt;a href=&quot;#é˜Ÿåˆ—ä¸å †æ ˆçš„åŒºåˆ«&quot; class=&quot;headerlink&quot; title=&quot;é˜Ÿåˆ—ä¸å †æ ˆçš„åŒºåˆ«&quot;&gt;&lt;/a&gt;é˜Ÿåˆ—ä¸å †æ ˆçš„åŒºåˆ«&lt;/h2&gt;&lt;p&gt;é˜Ÿåˆ—ç”±ä¸€ä¸ªå…¥å£å’Œä¸€ä¸ªå‡ºå£ç»„æˆï¼Œå…ˆè¿›å…ˆå‡ºã€‚å †æ ˆåªæœ‰ä¸€ä¸ªå£ï¼Œåè¿›å…ˆå‡ºã€‚&lt;/p&gt;
&lt;h2 id=&quot;
      
    
    </summary>
    
    
    
      <category term="å‰ç«¯" scheme="https://guaik.github.io/tags/%E5%89%8D%E7%AB%AF/"/>
    
      <category term="é˜Ÿåˆ—" scheme="https://guaik.github.io/tags/%E9%98%9F%E5%88%97/"/>
    
      <category term="èŠå¤©å®¤" scheme="https://guaik.github.io/tags/%E8%81%8A%E5%A4%A9%E5%AE%A4/"/>
    
      <category term="ä¼˜åŒ–" scheme="https://guaik.github.io/tags/%E4%BC%98%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>åŠ æƒéšæœºç®—æ³•</title>
    <link href="https://guaik.github.io/2020/04/12/%E5%8A%A0%E6%9D%83%E9%9A%8F%E6%9C%BA%E7%AE%97%E6%B3%95/"/>
    <id>https://guaik.github.io/2020/04/12/%E5%8A%A0%E6%9D%83%E9%9A%8F%E6%9C%BA%E7%AE%97%E6%B3%95/</id>
    <published>2020-04-12T14:02:06.000Z</published>
    <updated>2020-04-12T14:26:38.217Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ç™½è¯åŸç†"><a href="#ç™½è¯åŸç†" class="headerlink" title="ç™½è¯åŸç†"></a>ç™½è¯åŸç†</h2><p>ç”Ÿæ´»ä¸­æœ€å¸¸è§çš„ä¸€ä¸ªä¾‹å­ï¼šç°åœ¨æœ‰4ä¸ªçº¢çƒå’Œ6ä¸ªé»‘çƒï¼ŒæŠŠè¿™10ä¸ªçƒæ”¾å…¥åˆ°ä¸€ä¸ªä¸é€æ˜çš„è¢‹å­ä¸­æ‰“ä¹±ï¼Œé‚£ä¹ˆå»è¢‹å­ä¸­æ‹¿åˆ°çº¢çƒçš„æ¦‚ç‡æ˜¯4/10ï¼Œæ‹¿åˆ°é»‘çƒçš„æ¦‚ç‡æ˜¯6/10ï¼Œä¹Ÿå¯ä»¥è¯´è¢‹å­åˆ†é…ç»™æˆ‘çº¢çƒçš„æ¦‚ç‡æ˜¯4/10ï¼Œåˆ†é…ç»™æˆ‘é»‘çƒçš„æ¦‚ç‡æ˜¯6/10ã€‚</p><h2 id="å®é™…åº”ç”¨"><a href="#å®é™…åº”ç”¨" class="headerlink" title="å®é™…åº”ç”¨"></a>å®é™…åº”ç”¨</h2><ul><li><p>ç½‘å…³æœåŠ¡å™¨é€šå¸¸éƒ½ä¼šé€šè¿‡è´Ÿè½½å‡è¡¡å»åˆ†æ‘Šè®¡ç®—å‹åŠ›ï¼Œæœ‰çš„æœåŠ¡å™¨æ€§èƒ½ä¼šå¥½ä¸€äº›ï¼Œæœ‰çš„ä¼šå·®ä¸€äº›ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡æƒé‡é…æ¯”çš„å½¢å¼å°†è¾ƒå¤§çš„è®¡ç®—å‹åŠ›ç»™åˆ°æ€§èƒ½è¾ƒå¥½çš„æœåŠ¡å™¨ã€‚</p></li><li><p>å½“æŸå°æœåŠ¡å™¨çªç„¶å‡ºç°æ•…éšœæ—¶ï¼Œå¾®æœåŠ¡æ¶æ„å¯ä»¥é€šè¿‡æœåŠ¡æ³¨å†Œå‘ç°å°†æ•…éšœçš„æœåŠ¡å™¨ç§»é™¤ï¼Œå¦‚æœæ˜¯ç½‘å…³æœåŠ¡å™¨çš„è¯æˆ‘ä»¬å¯ä»¥å°†è´Ÿè½½å‡è¡¡çš„æƒé‡ç½®0ã€‚</p></li></ul><h2 id="å®ç°ä»£ç "><a href="#å®ç°ä»£ç " class="headerlink" title="å®ç°ä»£ç "></a>å®ç°ä»£ç </h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// å®ä¾‹å¯¹è±¡</span></span><br><span class="line"><span class="keyword">type</span> Object <span class="keyword">struct</span> &#123;</span><br><span class="line">    Weight <span class="keyword">int</span>         <span class="comment">// æƒé‡</span></span><br><span class="line">    Object <span class="keyword">interface</span>&#123;&#125; <span class="comment">// æœåŠ¡å¯¹è±¡</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è°ƒåº¦å¯¹è±¡</span></span><br><span class="line"><span class="keyword">type</span> Dispatch <span class="keyword">struct</span> &#123;</span><br><span class="line">    Sources     []*Object   <span class="comment">// æ‰€æœ‰æœåŠ¡å¯¹è±¡</span></span><br><span class="line">    SLB         []*Object   <span class="comment">// è´Ÿè½½å‡è¡¡ç”Ÿæˆçš„å¯¹è±¡</span></span><br><span class="line">    TotalWeight <span class="keyword">int</span>         <span class="comment">// æ€»æƒé‡</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dispatch *Dispatch)</span> <span class="title">Init</span><span class="params">()</span> <span class="params">(err error)</span></span> &#123;</span><br><span class="line">    dispatch.Sources = <span class="built_in">make</span>([]*LiveObject, <span class="number">0</span>)</span><br><span class="line">    dispatch.SLB = <span class="built_in">make</span>([]*LiveObject, <span class="number">0</span>)</span><br><span class="line">    dispatch.TotalWeight = <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡æ–°ç”Ÿæˆè´Ÿè½½å‡è¡¡é˜Ÿåˆ—</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dispatch *Dispatch)</span> <span class="title">reGenSLBArray</span><span class="params">()</span></span> &#123;</span><br><span class="line">    dispatch.SLB = <span class="built_in">make</span>([]*LiveObject, <span class="number">0</span>)</span><br><span class="line">    dispatch.TotalWeight = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> _, item := <span class="keyword">range</span> dispatch.Sources &#123;</span><br><span class="line">        dispatch.TotalWeight += item.Weight</span><br><span class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; item.Weight; i++ &#123;</span><br><span class="line">            dispatch.SLB = <span class="built_in">append</span>(dispatch.SLB, item)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// éšæœºæ’åˆ—é¡ºåº</span></span><br><span class="line">    rand.Seed(time.Now().UnixNano())</span><br><span class="line">    rand.Shuffle(dispatch.TotalWeight, <span class="function"><span class="keyword">func</span><span class="params">(i, j <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">        dispatch.SLB[i], dispatch.SLB[j] = dispatch.SLB[j], dispatch.SLB[i]</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ æœåŠ¡å¯¹è±¡</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dispatch *Dispatch)</span> <span class="title">AddObject</span><span class="params">(object *Object)</span></span> &#123;</span><br><span class="line">    dispatch.Sources = <span class="built_in">append</span>(dispatch.Sources, object)</span><br><span class="line">    dispatch.reGenSLBArray()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–å¯¹è±¡</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dispatch *Dispatch)</span> <span class="title">GetObject</span><span class="params">()</span> <span class="params">(object *Object)</span></span> &#123;</span><br><span class="line">    rand.Seed(time.Now().UnixNano())</span><br><span class="line">    <span class="keyword">return</span> dispatch.SLB[rand.Intn(dispatch.TotalWeight)]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ç™½è¯åŸç†&quot;&gt;&lt;a href=&quot;#ç™½è¯åŸç†&quot; class=&quot;headerlink&quot; title=&quot;ç™½è¯åŸç†&quot;&gt;&lt;/a&gt;ç™½è¯åŸç†&lt;/h2&gt;&lt;p&gt;ç”Ÿæ´»ä¸­æœ€å¸¸è§çš„ä¸€ä¸ªä¾‹å­ï¼šç°åœ¨æœ‰4ä¸ªçº¢çƒå’Œ6ä¸ªé»‘çƒï¼ŒæŠŠè¿™10ä¸ªçƒæ”¾å…¥åˆ°ä¸€ä¸ªä¸é€æ˜çš„è¢‹å­ä¸­æ‰“ä¹±ï¼Œé‚£ä¹ˆå»è¢‹å­ä¸­æ‹¿åˆ°çº¢çƒçš„æ¦‚ç‡æ˜¯4/
      
    
    </summary>
    
    
    
      <category term="golang" scheme="https://guaik.github.io/tags/golang/"/>
    
      <category term="è´Ÿè½½å‡è¡¡" scheme="https://guaik.github.io/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäºRedisçš„åˆ†å¸ƒå¼é”</title>
    <link href="https://guaik.github.io/2020/04/12/%E5%9F%BA%E4%BA%8ERedis%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"/>
    <id>https://guaik.github.io/2020/04/12/%E5%9F%BA%E4%BA%8ERedis%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/</id>
    <published>2020-04-12T12:38:39.000Z</published>
    <updated>2020-04-12T15:07:03.488Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨åˆ†å¸ƒå¼é”"><a href="#ä¸ºä»€ä¹ˆè¦ä½¿ç”¨åˆ†å¸ƒå¼é”" class="headerlink" title="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨åˆ†å¸ƒå¼é”"></a>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨åˆ†å¸ƒå¼é”</h2><p>ä¸¾ä¸ªæ —å­ï¼Œåœ¨è®¾è®¡ç›´æ’­é—´å¼€æ’­æµç¨‹çš„æ—¶å€™ä¼šæ‰§è¡Œå¾ˆå¤šåˆå§‹åŒ–çš„æ“ä½œï¼Œä¹Ÿä¼šåœ¨ç¼“å­˜ä¸­åˆ›å»ºæœ¬æ¬¡ç›´æ’­çš„è®°å½•æ•°æ®ï¼Œä¸ºäº†é¿å…ä¸»æ’­è¯¯æ“ä½œåŒæ—¶æ‰§è¡Œå¼€æ’­æµç¨‹å¤šæ¬¡ï¼Œåœ¨å¼€æ’­æˆåŠŸåä¼šè®¾ç½®å¼€æ’­çŠ¶æ€ï¼Œå¼€æ’­æ—¶åˆ¤æ–­çŠ¶æ€ä¸ºå·²å¼€æ’­åˆ™ä¸å¤„ç†ï¼Œç›´æ’­ç³»ç»Ÿæ˜¯å¤šå®ä¾‹éƒ¨ç½²çš„ï¼Œä¸ºäº†ä¿æŠ¤å¼€æ’­çŠ¶æ€ï¼Œéœ€è¦åšåˆ°åŒä¸€æ—¶é—´åªèƒ½ç”±ä¸€å°æœåŠ¡å™¨å¤„ç†å¼€æ’­æµç¨‹ï¼Œè¿™æ—¶å€™å°±ä¼šç”¨åˆ°åˆ†å¸ƒå¼é”è¿›è¡ŒåŠ é”ä¿æŠ¤ã€‚</p><h2 id="çº¿ç¨‹é”ä¸åˆ†å¸ƒå¼é”"><a href="#çº¿ç¨‹é”ä¸åˆ†å¸ƒå¼é”" class="headerlink" title="çº¿ç¨‹é”ä¸åˆ†å¸ƒå¼é”"></a>çº¿ç¨‹é”ä¸åˆ†å¸ƒå¼é”</h2><p>é”çš„æ„ä¹‰åœ¨äºä¿æŠ¤å…¨å±€å¯è§å¯¹è±¡ã€‚åœ¨å•è¿›ç¨‹ä¸­ä½¿ç”¨å¤šçº¿ç¨‹æ—¶ä¼šé€šè¿‡çº¿ç¨‹é”å»ä¿æŠ¤å½“å‰è¿›ç¨‹ä¸­çš„å…¨å±€å¯¹è±¡ï¼ˆæŸäº›æƒ…å†µå¯ç”¨åŸå­æ“ä½œï¼‰ã€‚åˆ†å¸ƒå¼ç³»ç»Ÿå¯ç†è§£ä¸ºå¤šè¿›ç¨‹ç³»ç»Ÿï¼Œçº¿ç¨‹é”æ— æ³•é”ä½å…¶ä»–è¿›ç¨‹ä¸­çš„æ‰§è¡Œæµç¨‹ï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªå…¨å±€çš„é”æ¥ç®¡æ§æ‰€æœ‰è¿›ç¨‹ä¸­çš„æ‰§è¡Œæµç¨‹ï¼ˆå¦‚æœç›¸åŒåç§°çš„é”å¤„äºä¸Šé”çŠ¶æ€åˆ™ç­‰å¾…ï¼‰ã€‚</p><h2 id="Redisä¸SetNX"><a href="#Redisä¸SetNX" class="headerlink" title="Redisä¸SetNX"></a>Redisä¸SetNX</h2><p>Redisæ˜¯å•è¿›ç¨‹ç³»ç»Ÿï¼Œå®ƒçš„SetNXæ˜¯ä¸ªåŸå­æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸¤ç‚¹æ¥å®ç°åˆ†å¸ƒå¼é”ã€‚å¦‚æœSetNXæ‰§è¡ŒæˆåŠŸåˆ™æ„å‘³ç€æ‹¿åˆ°äº†é”ï¼Œç›¸åæ‰§è¡Œå¤±è´¥åˆ™å¾ªç¯ç­‰å¾…æ‹¿é”æˆ–è¶…æ—¶é€€å‡ºã€‚</p><h2 id="è®¾è®¡æ³¨æ„äº‹é¡¹"><a href="#è®¾è®¡æ³¨æ„äº‹é¡¹" class="headerlink" title="è®¾è®¡æ³¨æ„äº‹é¡¹"></a>è®¾è®¡æ³¨æ„äº‹é¡¹</h2><p>1ã€ä¸ºäº†é¿å…å•æŒæœ‰é”çš„è¿›ç¨‹å¥”æºƒè€Œæ— æ³•é‡Šæ”¾é”ï¼Œæ‰€ä»¥å¿…é¡»èƒ½å¤Ÿä¸ºé”è®¾å®šè¿‡æœŸæ—¶é—´è‡ªåŠ¨é‡Šæ”¾é”èµ„æºã€‚</p><p>2ã€ä½¿ç”¨TTLæ£€æŸ¥é”æ˜¯å¦æˆåŠŸçš„è¢«è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå¦‚æœè¿”å›-1ï¼ˆæœªè¢«è®¾ç½®ï¼‰çš„è¯ï¼Œä½¿ç”¨Expireä¸ºå…¶è®¾å®šè¿‡æœŸæ—¶é—´ã€‚</p><p>3ã€åœ¨é‡Šæ”¾é”çš„æ—¶å€™éœ€è¦ä½¿ç”¨Watchå‘½ä»¤ï¼Œç¡®ä¿ç›‘æµ‹çš„å€¼åœ¨äº‹åŠ¡æ‰§è¡Œæ—¶æ—¶æœªè¢«æ”¹å˜ï¼Œå¦‚æœå…¶ä»–è¿›ç¨‹ä¿®æ”¹äº†é”ï¼Œä¼šè§¦å‘äº‹åŠ¡å¼‚å¸¸ï¼Œç„¶åé‡æ–°æ‰§è¡ŒWatchã€‚</p><hr><p>åˆ†äº«ä¸€ä¸ªæˆ‘å†™çš„Rediså°è£…ç±»ï¼Œä»…å®ç°äº†è¿æ¥å’Œé”</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> dao</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"time"</span></span><br><span class="line"></span><br><span class="line">    <span class="string">"github.com/go-redis/redis/v7"</span></span><br><span class="line">    uuid <span class="string">"github.com/satori/go.uuid"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Rds <span class="keyword">struct</span> &#123;</span><br><span class="line">    Client         *redis.Client</span><br><span class="line">    AcquireTimeout <span class="keyword">int32</span></span><br><span class="line">    LockTimeout    <span class="keyword">int32</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRds</span><span class="params">(host, passwd <span class="keyword">string</span>, db <span class="keyword">int</span>)</span> <span class="params">(rds *Rds, err error)</span></span> &#123;</span><br><span class="line">    rdsOpt := &amp;redis.Options&#123;</span><br><span class="line">        Addr:     host,</span><br><span class="line">        Password: passwd,</span><br><span class="line">        DB:       db,</span><br><span class="line">    &#125;</span><br><span class="line">    client := redis.NewClient(rdsOpt)</span><br><span class="line">    _, err = client.Ping().Result()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    rds = &amp;Rds&#123;Client: client, AcquireTimeout: <span class="number">10</span>, LockTimeout: <span class="number">10</span>&#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Rds)</span> <span class="title">AcquireLockWithTimeout</span><span class="params">(key <span class="keyword">string</span>)</span> <span class="params">(identifier <span class="keyword">string</span>, b <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">    identifier = uuid.NewV4().String()</span><br><span class="line">    lockname := <span class="string">"lock:"</span> + key</span><br><span class="line">    end := time.Now().Add(time.Second * time.Duration(r.AcquireTimeout))</span><br><span class="line">    <span class="keyword">for</span> time.Now().Before(end) &#123;</span><br><span class="line">        <span class="keyword">if</span> r.Client.SetNX(lockname, identifier, time.Second*time.Duration(r.LockTimeout)).Val() &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœkeyä¸å­˜åœ¨ï¼Œå¹¶æˆåŠŸè®¾ç½®äº†key</span></span><br><span class="line">            b = <span class="literal">true</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> r.Client.TTL(lockname).Val() == <span class="number">-1</span> &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœkeyå­˜åœ¨ï¼Œä½†æ˜¯æ²¡æœ‰å‰©ä½™æ—¶é—´</span></span><br><span class="line">            r.Client.Expire(lockname, time.Second*time.Duration(r.LockTimeout))</span><br><span class="line">        &#125;</span><br><span class="line">        time.Sleep(time.Microsecond)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Rds)</span> <span class="title">ReleaseLock</span><span class="params">(key, identifier <span class="keyword">string</span>)</span> <span class="params">(b <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">    lockname := <span class="string">"lock:"</span> + key</span><br><span class="line">    txf := <span class="function"><span class="keyword">func</span><span class="params">(tx *redis.Tx)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">        v, err := tx.Get(lockname).Result()</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">        _, err = tx.Pipelined(<span class="function"><span class="keyword">func</span><span class="params">(pipe redis.Pipeliner)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">            <span class="keyword">if</span> v == identifier &#123;</span><br><span class="line">                pipe.Del(lockname)</span><br><span class="line">                b = <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        err := r.Client.Watch(txf, lockname)</span><br><span class="line">        <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> err == redis.TxFailedErr &#123;</span><br><span class="line">            glog.Error(err)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;ä¸ºä»€ä¹ˆè¦ä½¿ç”¨åˆ†å¸ƒå¼é”&quot;&gt;&lt;a href=&quot;#ä¸ºä»€ä¹ˆè¦ä½¿ç”¨åˆ†å¸ƒå¼é”&quot; class=&quot;headerlink&quot; title=&quot;ä¸ºä»€ä¹ˆè¦ä½¿ç”¨åˆ†å¸ƒå¼é”&quot;&gt;&lt;/a&gt;ä¸ºä»€ä¹ˆè¦ä½¿ç”¨åˆ†å¸ƒå¼é”&lt;/h2&gt;&lt;p&gt;ä¸¾ä¸ªæ —å­ï¼Œåœ¨è®¾è®¡ç›´æ’­é—´å¼€æ’­æµç¨‹çš„æ—¶å€™ä¼šæ‰§è¡Œå¾ˆå¤šåˆå§‹åŒ–çš„æ“ä½œï¼Œä¹Ÿä¼šåœ¨ç¼“å­˜ä¸­åˆ›å»º
      
    
    </summary>
    
    
    
      <category term="golang" scheme="https://guaik.github.io/tags/golang/"/>
    
      <category term="redis" scheme="https://guaik.github.io/tags/redis/"/>
    
      <category term="åˆ†å¸ƒå¼é”" scheme="https://guaik.github.io/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/"/>
    
  </entry>
  
</feed>
